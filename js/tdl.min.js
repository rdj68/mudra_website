function define(){for(var a=[],b=0;b<arguments.length;++b)a.push(arguments[b]);1==a.length&&a.unshift([]),2==a.length&&a.unshift(void 0);for(var c=(a[0],a[1]),d=a[2],b=0;b<c.length;++b){var e=c[b].replace("./","tdl.");tdl.require(e)}"function"==typeof d&&d()}var tdl=tdl||{},goog=goog||{};window.Int32Array||(window.Int32Array=function(){},window.Float32Array=function(){},window.Uint16Array=function(){}),goog.typedef=!0,tdl.global=this,tdl.BROWSER_ONLY=!0,tdl.provided_=[],tdl.provide=function(a){if(tdl.getObjectByName(a)&&!tdl.implicitNamespaces_[a])throw'Namespace "'+a+'" already declared.';for(var b=a;b=b.substring(0,b.lastIndexOf("."));)tdl.implicitNamespaces_[b]=!0;tdl.exportPath_(a),tdl.provided_.push(a)},tdl.implicitNamespaces_={},tdl.exportPath_=function(a,b,c){var d,e=a.split("."),f=c||tdl.global;e[0]in f||!f.execScript||f.execScript("var "+e[0]);for(;e.length&&(d=e.shift());)!e.length&&tdl.isDef(b)?f[d]=b:f=f[d]?f[d]:f[d]={}},tdl.getObjectByName=function(a,b){for(var c=a.split("."),d=b||tdl.global,e=0;e<c.length;++e){var f=c[e];if(!d[f])return null;d=d[f]}return d},tdl.require=function(a){document.getElementsByTagName("script").length;if(!tdl.getObjectByName(a)){var b=tdl.getPathFromRule_(a);if(!b)throw new Error("tdl.require could not find: "+a);tdl.included_[b]=!0,tdl.writeScripts_()}},tdl.basePath="",tdl.included_={},tdl.dependencies_={visited:{},written:{}},tdl.findBasePath_=function(){var a=tdl.global.document;if("undefined"!=typeof a){if(tdl.global.BASE_PATH)return void(tdl.basePath=tdl.global.BASE_PATH);tdl.global.BASE_PATH=null;for(var b,c="tdl/base.js",d=a.getElementsByTagName("script"),e=0;b=d[e];e++){var f=b.src,g=f.length;if(f.substr(g-c.length)==c)return void(tdl.basePath=f.substr(0,g-c.length))}}},tdl.writeScriptTag_=function(a){var b=tdl.global.document;if("undefined"!=typeof b&&!tdl.dependencies_.written[a]){tdl.dependencies_.written[a]=!0;var c='<script type="text/javascript" src="'+a+'"></script>';b.write(c)}},tdl.writeScripts_=function(){function a(a){if(!(a in d.written)){if(a in d.visited)return void(a in c||(c[a]=!0,b.push(a)));d.visited[a]=!0,a in c||(c[a]=!0,b.push(a))}}var b=[],c={},d=tdl.dependencies_;for(var e in tdl.included_)d.written[e]||a(e);for(var f=0;f<b.length;f++){if(!b[f])throw Error("Undefined script input");tdl.writeScriptTag_(tdl.basePath+b[f])}},tdl.getPathFromRule_=function(a){var b=a.split(".");return b.join("/")+".js"},tdl.findBasePath_(),tdl.isDef=function(a){return"undefined"!=typeof a},tdl.exportSymbol=function(a,b,c){tdl.exportPath_(a,b,c)},tdl.provide("tdl.base"),tdl.base=tdl.base||{},tdl.base.isArray=function(a){var b=a;return"object"==typeof a&&null!==a&&"length"in b&&"splice"in b},tdl.base.maybeDeobfuscateFunctionName_=function(a){return a},tdl.base.inherit=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c},tdl.base.parseErrorStack=function(a){var b,c,d=[];if(!a||!a.stack)return d;for(var e=a.stack.split("\n"),f=0;f<e.length-1;f++){var g=e[f];b=g.match(/^([a-zA-Z0-9_$]*)/)[1],b=b?tdl.base.maybeDeobfuscateFunctionName_(b):"anonymous";var h=g.match(/(.*:[0-9]+)$/);c=h&&h[1],c||(c="(unknown)"),d[d.length]=b+" : "+c}for(var i=/^anonymous :/;d.length&&i.exec(d[d.length-1]);)d.length=d.length-1;return d},tdl.base.getFunctionName=function(a){var b=a.toString().match(/function(\s*)(\w*)/);return b&&b.length>=2&&b[2]?tdl.base.maybeDeobfuscateFunctionName_(b[2]):"anonymous"},tdl.base.formatErrorStack=function(a){for(var b="",c=0;c<a.length;c++)b+="> "+a[c]+"\n";return b},tdl.base.getStackTrace=function(stripCount){var result="";if("undefined"!=typeof arguments.caller){for(var a=arguments.caller;null!=a;a=a.caller)if(result+="> "+tdl.base.getFunctionName(a.callee)+"\n",a.caller==a){result+="*";break}}else{var testExcp;try{eval("var var;")}catch(testExcp){var stack=tdl.base.parseErrorStack(testExcp);result+=tdl.base.formatErrorStack(stack.slice(3+stripCount,stack.length))}}return result},tdl.base.IsMSIE=function(){var a=navigator.userAgent.toLowerCase(),b=/msie/.test(a)&&!/opera/.test(a);return b},define(["./base-rs"],function(){return tdl.provide("tdl.buffers"),tdl.buffers=tdl.buffers||{},tdl.buffers.Buffer=function(a,b){var c=b||gl.ARRAY_BUFFER,d=gl.createBuffer();this.target=c,this.buf=d,this.set(a)},tdl.buffers.Buffer.prototype.set=function(a,b){if(this.numComponents_=a.numComponents,this.numElements_=a.numElements,this.totalComponents_=this.numComponents_*this.numElements_,a.buffer instanceof Float32Array)this.type_=gl.FLOAT,this.normalize_=!1;else if(a.buffer instanceof Uint8Array)this.type_=gl.UNSIGNED_BYTE,this.normalize_=!0;else if(a.buffer instanceof Int8Array)this.type_=gl.BYTE,this.normalize_=!0;else if(a.buffer instanceof Uint16Array)this.type_=gl.UNSIGNED_SHORT,this.normalize_=!0;else{if(!(a.buffer instanceof Int16Array))throw"unhandled type:"+typeof a.buffer;this.type_=gl.SHORT,this.normalize_=!0}gl.bindBuffer(this.target,this.buf),gl.bufferData(this.target,a.buffer,b||gl.STATIC_DRAW)},tdl.buffers.Buffer.prototype.setRange=function(a,b){gl.bindBuffer(this.target,this.buf),gl.bufferSubData(this.target,b,a)},tdl.buffers.Buffer.prototype.type=function(){return this.type_},tdl.buffers.Buffer.prototype.numComponents=function(){return this.numComponents_},tdl.buffers.Buffer.prototype.numElements=function(){return this.numElements_},tdl.buffers.Buffer.prototype.totalComponents=function(){return this.totalComponents_},tdl.buffers.Buffer.prototype.buffer=function(){return this.buf},tdl.buffers.Buffer.prototype.stride=function(){return 0},tdl.buffers.Buffer.prototype.normalize=function(){return this.normalize_},tdl.buffers.Buffer.prototype.offset=function(){return 0},tdl.buffers}),define(["./base-rs","./io","./log"],function(){return tdl.provide("tdl.clock"),tdl.clock=tdl.clock||{},tdl.clock.createClock=function(a,b){return a?new tdl.clock.SyncedClock(a,b):new tdl.clock.LocalClock},tdl.clock.LocalClock=function(){},tdl.clock.LocalClock.prototype.getTime=function(){return.001*(new Date).getTime()},tdl.clock.SyncedClock=function(a,b){this.url=b||window.location.href,this.syncRate=a||10,this.timeOffset=0,this.syncToServer()},tdl.clock.SyncedClock.prototype.getLocalTime_=function(){return.001*(new Date).getTime()},tdl.clock.SyncedClock.prototype.syncToServer=function(){var a=this,b=this.getLocalTime_();tdl.io.sendJSON(this.url,{cmd:"time"},function(c,d){if(d)tdl.log("error: syncToServer: "+d);else{var e=a.getLocalTime_(),f=e-b,g=c.time+.5*f;a.timeOffset=g-e,tdl.log("new timeoffset: "+a.timeOffset)}setTimeout(function(){a.syncToServer()},1e3*a.syncRate)})},tdl.clock.SyncedClock.prototype.getTime=function(){return.001*(new Date).getTime()+this.timeOffset},tdl.clock}),define(["./base-rs"],function(){return tdl.provide("tdl.fast"),tdl.fast=tdl.fast||{},window.Float32Array||(window.Float32Array=function(){}),tdl.fast.temp0v3_=new Float32Array(3),tdl.fast.temp1v3_=new Float32Array(3),tdl.fast.temp2v3_=new Float32Array(3),tdl.fast.temp0v4_=new Float32Array(4),tdl.fast.temp1v4_=new Float32Array(4),tdl.fast.temp2v4_=new Float32Array(4),tdl.fast.temp0m4_=new Float32Array(16),tdl.fast.temp1m4_=new Float32Array(16),tdl.fast.temp2m4_=new Float32Array(16),tdl.fast.matrix4=tdl.fast.matrix4||{},tdl.fast.rowMajor=tdl.fast.rowMajor||{},tdl.fast.columnMajor=tdl.fast.columnMajor||{},tdl.fast.addVector=function(a,b,c){for(var d=b.length,e=0;d>e;++e)a[e]=b[e]+c[e];return a},tdl.fast.subVector=function(a,b,c){for(var d=b.length,e=0;d>e;++e)a[e]=b[e]-c[e];return a},tdl.fast.lerpVector=function(a,b,c,d){for(var e=b.length,f=0;e>f;++f)a[f]=(1-d)*b[f]+d*c[f];return a},tdl.fast.divVectorScalar=function(a,b,c){for(var d=b.length,e=0;d>e;++e)a[e]=b[e]/c;return a},tdl.fast.cross=function(a,b,c){return a[0]=b[1]*c[2]-b[2]*c[1],a[1]=b[2]*c[0]-b[0]*c[2],a[2]=b[0]*c[1]-b[1]*c[0],a},tdl.fast.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},tdl.fast.normalize=function(a,b){for(var c=0,d=b.length,e=0;d>e;++e)c+=b[e]*b[e];if(c=Math.sqrt(c),c>1e-5)for(var e=0;d>e;++e)a[e]=b[e]/c;else for(var e=0;d>e;++e)a[e]=0;return a},tdl.fast.negativeVector=function(a,b){for(var c=b.length,d=0;c>d;++d)a[d]=-b[d];return a},tdl.fast.negativeMatrix=function(a,b){for(var c=b.length,d=0;c>d;++d)a[d]=-b[d];return a},tdl.fast.copyVector=function(a,b){return a.set(b),a},tdl.fast.copyMatrix=function(a,b){return a.set(b),a},tdl.fast.mulScalarVector=function(a,b,c){for(var d=c.length,e=0;d>e;++e)a[e]=b*c[e];return a},tdl.fast.mulVectorScalar=function(a,b,c){return tdl.fast.mulScalarVector(a,c,b)},tdl.fast.mulScalarMatrix=function(a,b,c){for(var d=c.length,e=0;d>e;++e)a[e]=b*c[e];return a},tdl.fast.mulMatrixScalar=function(a,b,c){return tdl.fast.mulScalarMatrix(a,c,b)},tdl.fast.mulVectorVector=function(a,b,c){for(var d=b.length,e=0;d>e;++e)a[e]=b[e]*c[e];return a},tdl.fast.divVectorVector=function(a,b,c){for(var d=b.length,e=0;d>e;++e)a[e]=b[e]/c[e];return a},tdl.fast.rowMajor.mulVectorMatrix4=function(a,b,c){for(var d=0;4>d;++d){a[d]=0;for(var e=0;4>e;++e)a[d]+=b[e]*c[4*e+d]}return a},tdl.fast.columnMajor.mulVectorMatrix4=function(a,b,c){for(var d=(c.length,b.length,0);4>d;++d){a[d]=0;for(var e=4*d,f=0;4>f;++f)a[d]+=b[f]*c[e+f]}return a},tdl.fast.mulVectorMatrix4=null,tdl.fast.rowMajor.mulMatrix4Vector=function(a,b,c){for(var d=0;4>d;++d){a[d]=0;for(var e=4*d,f=0;4>f;++f)a[d]+=b[e+f]*c[f]}return a},tdl.fast.columnMajor.mulMatrix4Vector=function(a,b,c){for(var d=0;4>d;++d){a[d]=0;for(var e=0;4>e;++e)a[d]+=c[e]*b[4*e+d]}return a},tdl.fast.mulMatrix4Vector=null,tdl.fast.rowMajor.mulMatrixMatrix3=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=d*m+e*p+f*s,a[1]=d*n+e*q+f*t,a[2]=d*o+e*r+f*u,a[3]=g*m+h*p+i*s,a[4]=g*n+h*q+i*t,a[5]=g*o+h*r+i*u,a[6]=j*m+k*p+l*s,a[7]=j*n+k*q+l*t,a[8]=j*o+k*r+l*u,a},tdl.fast.columnMajor.mulMatrixMatrix3=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=d*m+g*n+j*o,a[1]=e*m+h*n+k*o,a[2]=f*m+i*n+l*o,a[3]=d*p+g*q+j*r,a[4]=e*p+h*q+k*r,a[5]=f*p+i*q+l*r,a[6]=d*s+g*t+j*u,a[7]=e*s+h*t+k*u,a[8]=f*s+i*t+l*u,a},tdl.fast.mulMatrixMatrix3=null,tdl.fast.rowMajor.mulMatrixMatrix4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3],x=c[4],y=c[5],z=c[6],A=c[7],B=c[8],C=c[9],D=c[10],E=c[11],F=c[12],G=c[13],H=c[14],I=c[15];return a[0]=d*t+e*x+f*B+g*F,a[1]=d*u+e*y+f*C+g*G,a[2]=d*v+e*z+f*D+g*H,a[3]=d*w+e*A+f*E+g*I,a[4]=h*t+i*x+j*B+k*F,a[5]=h*u+i*y+j*C+k*G,a[6]=h*v+i*z+j*D+k*H,a[7]=h*w+i*A+j*E+k*I,a[8]=l*t+m*x+n*B+o*F,a[9]=l*u+m*y+n*C+o*G,a[10]=l*v+m*z+n*D+o*H,a[11]=l*w+m*A+n*E+o*I,a[12]=p*t+q*x+r*B+s*F,a[13]=p*u+q*y+r*C+s*G,a[14]=p*v+q*z+r*D+s*H,a[15]=p*w+q*A+r*E+s*I,a},tdl.fast.columnMajor.mulMatrixMatrix4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3],x=c[4],y=c[5],z=c[6],A=c[7],B=c[8],C=c[9],D=c[10],E=c[11],F=c[12],G=c[13],H=c[14],I=c[15];return a[0]=d*t+h*u+l*v+p*w,a[1]=e*t+i*u+m*v+q*w,a[2]=f*t+j*u+n*v+r*w,a[3]=g*t+k*u+o*v+s*w,a[4]=d*x+h*y+l*z+p*A,a[5]=e*x+i*y+m*z+q*A,a[6]=f*x+j*y+n*z+r*A,a[7]=g*x+k*y+o*z+s*A,a[8]=d*B+h*C+l*D+p*E,a[9]=e*B+i*C+m*D+q*E,a[10]=f*B+j*C+n*D+r*E,a[11]=g*B+k*C+o*D+s*E,a[12]=d*F+h*G+l*H+p*I,a[13]=e*F+i*G+m*H+q*I,a[14]=f*F+j*G+n*H+r*I,a[15]=g*F+k*G+o*H+s*I,a},tdl.fast.mulMatrixMatrix4=null,tdl.fast.rowMajor.column4=function(a,b,c){for(var d=0;4>d;++d)a[d]=b[4*d+c];return a},tdl.fast.columnMajor.column4=function(a,b,c){var d=4*c;return a[0]=b[d+0],a[1]=b[d+1],a[2]=b[d+2],a[3]=b[d+3],a},tdl.fast.column4=null,tdl.fast.rowMajor.row4=function(a,b,c){var d=4*c;return a[0]=b[d+0],a[1]=b[d+1],a[2]=b[d+2],a[3]=b[d+3],a},tdl.fast.columnMajor.row4=function(a,b,c){for(var d=0;4>d;++d)a[d]=b[4*d+c];return a},tdl.fast.row4=null,tdl.fast.identity4=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.transpose4=function(a,b){if(a===b){var c;return c=b[1],b[1]=b[4],b[4]=c,c=b[2],b[2]=b[8],b[8]=c,c=b[3],b[3]=b[12],b[12]=c,c=b[6],b[6]=b[9],b[9]=c,c=b[7],b[7]=b[13],b[13]=c,c=b[11],b[11]=b[14],b[14]=c,a}var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15];return a[0]=d,a[1]=h,a[2]=l,a[3]=p,a[4]=e,a[5]=i,a[6]=m,a[7]=q,a[8]=f,a[9]=j,a[10]=n,a[11]=r,a[12]=g,a[13]=k,a[14]=o,a[15]=s,a},tdl.fast.inverse4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=m*r,t=q*n,u=i*r,v=q*j,w=i*n,x=m*j,y=e*r,z=q*f,A=e*n,B=m*f,C=e*j,D=i*f,E=k*p,F=o*l,G=g*p,H=o*h,I=g*l,J=k*h,K=c*p,L=o*d,M=c*l,N=k*d,O=c*h,P=g*d,Q=s*h+v*l+w*p-(t*h+u*l+x*p),R=t*d+y*l+B*p-(s*d+z*l+A*p),S=u*d+z*h+C*p-(v*d+y*h+D*p),T=x*d+A*h+D*l-(w*d+B*h+C*l),U=1/(c*Q+g*R+k*S+o*T);return a[0]=U*Q,a[1]=U*R,a[2]=U*S,a[3]=U*T,a[4]=U*(t*g+u*k+x*o-(s*g+v*k+w*o)),a[5]=U*(s*c+z*k+A*o-(t*c+y*k+B*o)),a[6]=U*(v*c+y*g+D*o-(u*c+z*g+C*o)),a[7]=U*(w*c+B*g+C*k-(x*c+A*g+D*k)),a[8]=U*(E*j+H*n+I*r-(F*j+G*n+J*r)),a[9]=U*(F*f+K*n+N*r-(E*f+L*n+M*r)),a[10]=U*(G*f+L*j+O*r-(H*f+K*j+P*r)),a[11]=U*(J*f+M*j+P*n-(I*f+N*j+O*n)),a[12]=U*(G*m+J*q+F*i-(I*q+E*i+H*m)),a[13]=U*(M*q+E*e+L*m-(K*m+N*q+F*e)),a[14]=U*(K*i+P*q+H*e-(O*q+G*e+L*i)),a[15]=U*(O*m+I*e+N*i-(M*i+P*m+J*e)),a},tdl.fast.matrix4.inverse=function(a,b){return tdl.fast.inverse4(a,b)},tdl.fast.matrix4.mul=function(a,b,c){return tdl.fast.mulMatrixMatrix4(a,b,c)},tdl.fast.matrix4.copy=function(a,b){return tdl.fast.copyMatrix(a,b)},tdl.fast.matrix4.setTranslation=function(a,b){return a[12]=b[0],a[13]=b[1],a[14]=b[2],a[15]=1,a},tdl.fast.matrix4.getTranslation=function(a,b){return a[0]=b[12],a[1]=b[13],a[2]=b[14],a},tdl.fast.matrix4.identity=function(a){return tdl.fast.identity4(a)},tdl.fast.matrix4.getAxis=function(a,b,c){var d=4*c;return a[0]=b[d+0],a[1]=b[d+1],a[2]=b[d+2],a},tdl.fast.matrix4.perspective=function(a,b,c,d,e){var f=Math.tan(.5*Math.PI-.5*b),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(d+e)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=d*e*g*2,a[15]=0,a},tdl.fast.matrix4.ortho=function(a,b,c,d,e,f,g){return a[0]=2/(c-b),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(e-d),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-1/(g-f),a[11]=0,a[12]=(c+b)/(b-c),a[13]=(e+d)/(d-e),a[14]=-f/(f-g),a[15]=1,a},tdl.fast.matrix4.frustum=function(a,b,c,d,e,f,g){var h=c-b,i=e-d,j=f-g;return a[0]=2*f/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f/i,a[6]=0,a[7]=0,a[8]=(b+c)/h,a[9]=(e+d)/i,a[10]=g/j,a[11]=-1,a[12]=0,a[13]=0,a[14]=f*g/j,a[15]=0,a},tdl.fast.matrix4.lookAt=function(a,b,c,d){var e=tdl.fast.temp0v3_,f=tdl.fast.temp1v3_,g=tdl.fast.temp2v3_,h=tdl.fast.normalize(e,tdl.fast.subVector(e,b,c)),i=tdl.fast.normalize(f,tdl.fast.cross(f,d,h)),j=tdl.fast.cross(g,h,i);return a[0]=i[0],a[1]=j[0],a[2]=h[0],a[3]=0,a[4]=i[1],a[5]=j[1],a[6]=h[1],a[7]=0,a[8]=i[2],a[9]=j[2],a[10]=h[2],a[11]=0,a[12]=-tdl.fast.dot(i,b),a[13]=-tdl.fast.dot(j,b),a[14]=-tdl.fast.dot(h,b),a[15]=1,a},tdl.fast.matrix4.cameraLookAt=function(a,b,c,d){var e=tdl.fast.temp0v3_,f=tdl.fast.temp1v3_,g=tdl.fast.temp2v3_,h=tdl.fast.normalize(e,tdl.fast.subVector(e,b,c)),i=tdl.fast.normalize(f,tdl.fast.cross(f,d,h)),j=tdl.fast.cross(g,h,i);return a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=0,a[4]=j[0],a[5]=j[1],a[6]=j[2],a[7]=0,a[8]=h[0],a[9]=h[1],a[10]=h[2],a[11]=0,a[12]=b[0],a[13]=b[1],a[14]=b[2],a[15]=1,a},tdl.fast.matrix4.translation=function(a,b){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=b[0],a[13]=b[1],a[14]=b[2],a[15]=1,a},tdl.fast.matrix4.translate=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3],j=a[4],k=a[5],l=a[6],m=a[7],n=a[8],o=a[9],p=a[10],q=a[11],r=a[12],s=a[13],t=a[14],u=a[15];return a[12]=f*c+j*d+n*e+r,a[13]=g*c+k*d+o*e+s,a[14]=h*c+l*d+p*e+t,a[15]=i*c+m*d+q*e+u,a},tdl.fast.matrix4.transpose=tdl.fast.transpose4,tdl.fast.matrix4.rotationX=function(a,b){var c=Math.cos(b),d=Math.sin(b);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=c,a[6]=d,a[7]=0,a[8]=0,a[9]=-d,a[10]=c,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.matrix4.rotateX=function(a,b){var c=a[4],d=a[5],e=a[6],f=a[7],g=a[8],h=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);return a[4]=k*c+l*g,a[5]=k*d+l*h,a[6]=k*e+l*i,a[7]=k*f+l*j,a[8]=k*g-l*c,a[9]=k*h-l*d,a[10]=k*i-l*e,a[11]=k*j-l*f,a},tdl.fast.matrix4.rotationY=function(a,b){var c=Math.cos(b),d=Math.sin(b);return a[0]=c,a[1]=0,a[2]=-d,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=d,a[9]=0,a[10]=c,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.matrix4.rotateY=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[8],h=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);return a[0]=k*c-l*g,a[1]=k*d-l*h,a[2]=k*e-l*i,a[3]=k*f-l*j,a[8]=k*g+l*c,a[9]=k*h+l*d,a[10]=k*i+l*e,a[11]=k*j+l*f,a},tdl.fast.matrix4.rotationZ=function(a,b){var c=Math.cos(b),d=Math.sin(b);return a[0]=c,a[1]=d,a[2]=0,a[3]=0,a[4]=-d,a[5]=c,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=Math.cos(b),l=Math.sin(b);return a[0]=k*c+l*g,a[1]=k*d+l*h,a[2]=k*e+l*i,a[3]=k*f+l*j,a[4]=k*g-l*c,a[5]=k*h-l*d,a[6]=k*i-l*e,a[7]=k*j-l*f,a},tdl.fast.matrix4.axisRotation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=Math.sqrt(d*d+e*e+f*f);d/=g,e/=g,f/=g;var h=d*d,i=e*e,j=f*f,k=Math.cos(c),l=Math.sin(c),m=1-k;return a[0]=h+(1-h)*k,a[1]=d*e*m+f*l,a[2]=d*f*m-e*l,a[3]=0,a[4]=d*e*m-f*l,a[5]=i+(1-i)*k,a[6]=e*f*m+d*l,a[7]=0,a[8]=d*f*m+e*l,a[9]=e*f*m-d*l,a[10]=j+(1-j)*k,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=Math.sqrt(d*d+e*e+f*f);d/=g,e/=g,f/=g;{var h=d*d,i=e*e,j=f*f,k=Math.cos(c),l=Math.sin(c),m=1-k,n=h+(1-h)*k,o=d*e*m+f*l,p=d*f*m-e*l,q=d*e*m-f*l,r=i+(1-i)*k,s=e*f*m+d*l,t=d*f*m+e*l,u=e*f*m-d*l,v=j+(1-j)*k,w=a[0],x=a[1],y=a[2],z=a[3],A=a[4],B=a[5],C=a[6],D=a[7],E=a[8],F=a[9],G=a[10],H=a[11];a[12],a[13],a[14],a[15]}return a[0]=n*w+o*A+p*E,a[1]=n*x+o*B+p*F,a[2]=n*y+o*C+p*G,a[3]=n*z+o*D+p*H,a[4]=q*w+r*A+s*E,a[5]=q*x+r*B+s*F,a[6]=q*y+r*C+s*G,a[7]=q*z+r*D+s*H,a[8]=t*w+u*A+v*E,a[9]=t*x+u*B+v*F,a[10]=t*y+u*C+v*G,a[11]=t*z+u*D+v*H,a},tdl.fast.matrix4.scaling=function(a,b){return a[0]=b[0],a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=b[1],a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=b[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},tdl.fast.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c*a[0],a[1]=c*a[1],a[2]=c*a[2],a[3]=c*a[3],a[4]=d*a[4],a[5]=d*a[5],a[6]=d*a[6],a[7]=d*a[7],a[8]=e*a[8],a[9]=e*a[9],a[10]=e*a[10],a[11]=e*a[11],a},tdl.fast.installRowMajorFunctions=function(){for(var a in tdl.fast.rowMajor)tdl.fast[a]=tdl.fast.rowMajor[a]},tdl.fast.installColumnMajorFunctions=function(){for(var a in tdl.fast.columnMajor)tdl.fast[a]=tdl.fast.columnMajor[a]},tdl.fast.installRowMajorFunctions(),tdl.fast}),define(["./base-rs"],function(){return tdl.provide("tdl.fps"),tdl.fps=tdl.fps||{},tdl.fps.NUM_FRAMES_TO_AVERAGE=16,tdl.fps.FPSTimer=function(){this.totalTime_=tdl.fps.NUM_FRAMES_TO_AVERAGE,this.timeTable_=[],this.timeTableCursor_=0;for(var a=0;a<tdl.fps.NUM_FRAMES_TO_AVERAGE;++a)this.timeTable_[a]=1;this.instantaneousFPS=0,this.averageFPS=0},tdl.fps.FPSTimer.prototype.update=function(a){this.totalTime_+=a-this.timeTable_[this.timeTableCursor_],this.timeTable_[this.timeTableCursor_]=a,++this.timeTableCursor_,this.timeTableCursor_==tdl.fps.NUM_FRAMES_TO_AVERAGE&&(this.timeTableCursor_=0),this.instantaneousFPS=Math.floor(1/a+.5),this.averageFPS=Math.floor(1/(this.totalTime_/tdl.fps.NUM_FRAMES_TO_AVERAGE)+.5)},tdl.fps}),define(["./base-rs","./textures"],function(){return tdl.provide("tdl.framebuffers"),tdl.framebuffers=tdl.framebuffers||{},tdl.framebuffers.createFramebuffer=function(a,b,c){return new tdl.framebuffers.Framebuffer(a,b,c)},tdl.framebuffers.createCubeFramebuffer=function(a,b){return new tdl.framebuffers.CubeFramebuffer(a,b)},tdl.framebuffers.BackBuffer=function(){this.depth=!0,this.buffer=null},tdl.framebuffers.BackBuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,this.width,this.height)},Object.prototype.__defineSetter__&&(tdl.framebuffers.BackBuffer.prototype.__defineGetter__("width",function(){return gl.drawingBufferWidth||gl.canvas.width}),tdl.framebuffers.BackBuffer.prototype.__defineGetter__("height",function(){return gl.drawingBufferHeight||gl.canvas.height})),tdl.framebuffers.getBackBuffer=function(){return new tdl.framebuffers.BackBuffer},tdl.framebuffers.Framebuffer=function(a,b,c){this.width=a,this.height=b,this.depth=c;var d=new tdl.textures.SolidTexture([0,0,0,0]);this.initializeTexture(d);var e=gl.createFramebuffer();if(gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,d.texture,0),this.depth)if(gl.tdl.depthTexture){var f=new tdl.textures.DepthTexture(this.width,this.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,f.texture,0),this.depthTexture=f}else{var g=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,g),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,g),gl.bindRenderbuffer(gl.RENDERBUFFER,null),this.depthRenderbuffer=g}var h=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(h!=gl.FRAMEBUFFER_COMPLETE&&!gl.isContextLost())throw"gl.checkFramebufferStatus() returned "+tdl.webgl.glEnumToString(h);this.framebuffer=e,this.texture=d,gl.bindFramebuffer(gl.FRAMEBUFFER,null)},tdl.framebuffers.Framebuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer),gl.viewport(0,0,this.width,this.height)},tdl.framebuffers.Framebuffer.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,gl.drawingBufferWidth||gl.canvas.width,gl.drawingBufferHeight||gl.canvas.height)},tdl.framebuffers.Framebuffer.prototype.initializeTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,a.texture),a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),a.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)},tdl.framebuffers.CubeFramebuffer=function(a,b){this.size=a,this.depth=b;var c=new tdl.textures.CubeMap(this.size);gl.bindTexture(gl.TEXTURE_CUBE_MAP,c.texture),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),c.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),c.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);for(var d=0;6>d;++d)gl.texImage2D(tdl.textures.CubeMap.faceTargets[d],0,gl.RGBA,this.size,this.size,0,gl.RGBA,gl.UNSIGNED_BYTE,null);if(this.depth){var e=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.size,this.size)}this.framebuffers=[];for(var d=0;6>d;++d){var f=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,tdl.textures.CubeMap.faceTargets[d],c.texture,0),this.depth&&gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,e);var g=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(g!=gl.FRAMEBUFFER_COMPLETE)throw"gl.checkFramebufferStatus() returned "+WebGLDebugUtils.glEnumToString(g);this.framebuffers.push(f)}gl.bindRenderbuffer(gl.RENDERBUFFER,null),this.texture=c},tdl.framebuffers.CubeFramebuffer.prototype.bind=function(a){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffers[a]),gl.viewport(0,0,this.size,this.size)},tdl.framebuffers.CubeFramebuffer.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,gl.drawingBufferWidth||gl.canvas.width,gl.drawingBufferHeight||gl.canvas.height)},tdl.framebuffers.Float32Framebuffer=function(a,b,c){if(!gl.getExtension("OES_texture_float"))throw"Requires OES_texture_float extension";tdl.framebuffers.Framebuffer.call(this,a,b,c)},tdl.base.inherit(tdl.framebuffers.Float32Framebuffer,tdl.framebuffers.Framebuffer),tdl.framebuffers.Float32Framebuffer.prototype.initializeTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,a.texture),a.setParameter(gl.TEXTURE_MIN_FILTER,gl.NEAREST),a.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST),a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.FLOAT,null)},tdl.framebuffers}),define(["./base-rs"],function(){return tdl.provide("tdl.fullscreen"),tdl.fullscreen=tdl.fullscreen||{},tdl.fullscreen.requestFullScreen=function(a){a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):a.mozRequestFullScreen&&a.mozRequestFullScreen()},tdl.fullscreen.cancelFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen&&document.mozCancelFullScreen()},tdl.fullscreen.onFullScreenChange=function(a,b){var c=function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullScreen||document.webkitIsFullScreen};document.addEventListener("fullscreenchange",function(){b(c())}),a.addEventListener("webkitfullscreenchange",function(){b(c())}),document.addEventListener("mozfullscreenchange",function(){b(c())})},tdl.fullscreen}),define(["./base-rs"],function(){return tdl.provide("tdl.io"),tdl.io=tdl.io||{},tdl.io.createLoadInfo=function(a){return new tdl.io.LoadInfo(a)},tdl.io.LoadInfo=function(a){this.request_=a,this.streamLength_=0,this.children_=[]},tdl.io.LoadInfo.prototype.addChild=function(a){this.children_.push(a)},tdl.io.LoadInfo.prototype.finish=function(){this.request_&&(this.hasStatus_&&(this.streamLength_=this.request_.streamLength),this.request_=null)},tdl.io.LoadInfo.prototype.getTotalKnownBytesToStreamSoFar=function(){for(var a=this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownBytesToStreamSoFar();return a},tdl.io.LoadInfo.prototype.getTotalBytesDownloaded=function(){for(var a=this.request_&&this.hasStatus_?this.request_.bytesReceived:this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalBytesDownloaded();return a},tdl.io.LoadInfo.prototype.getTotalKnownRequestsToStreamSoFar=function(){for(var a=1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownRequestToStreamSoFar();return a},tdl.io.LoadInfo.prototype.getTotalRequestsDownloaded=function(){for(var a=this.request_?0:1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalRequestsDownloaded();return a},tdl.io.LoadInfo.prototype.getKnownProgressInfoSoFar=function(){var a=0,b=this.getTotalKnownBytesToStreamSoFar(),c=this.getTotalBytesDownloaded();b>0&&(a=Math.floor(c/b*100));var d=1048576>b?1024:1048576;return{percent:a,downloaded:(c/d).toFixed(2),totalBytes:(b/d).toFixed(2),base:d,suffix:1024==d?"kb":"mb"}},tdl.io.loadTextFileSynchronous=function(a){var b,c='loadTextFileSynchronous failed to load url "'+a+'"';if(window.XMLHttpRequest)b=new XMLHttpRequest,b.overrideMimeType&&b.overrideMimeType("text/plain");else{if(!window.ActiveXObject)throw"XMLHttpRequest is disabled";b=new ActiveXObject("MSXML2.XMLHTTP.3.0")}if(b.open("GET",a,!1),b.send(null),4!=b.readyState)throw c;return b.responseText},tdl.io.loadTextFile=function(a,b){var c;if(window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain; charset=utf-8");else{if(!window.ActiveXObject)throw"XMLHttpRequest is disabled";c=new ActiveXObject("MSXML2.XMLHTTP.3.0")}var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);var e=function(){if(4==c.readyState){var e="",f=200==c.status||0==c.status;f&&(e=c.responseText),d.finish(),b(e,f?null:"could not load: "+a)}};return c.onreadystatechange=e,c.send(null),d},tdl.io.loadArrayBuffer=function(a,b){var c;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";c=new XMLHttpRequest;var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);var e=function(){if(4==c.readyState){var e=200==c.status||0==c.status;e&&(arrayBuffer=c.response),d.finish(),b(arrayBuffer,e?null:"could not load: "+a)}};if(c.onreadystatechange=e,void 0===c.responseType)throw"no support for binary files";return c.responseType="arraybuffer",c.send(null),d},tdl.io.loadJSON=function(a,b){var c;if(window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain");else{if(!window.ActiveXObject)throw"XMLHttpRequest is disabled";c=new ActiveXObject("MSXML2.XMLHTTP.3.0")}var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);var e=function(){if(4==c.readyState){var e=void 0,f=200==c.status||0==c.status;if(f)try{e=JSON.parse(c.responseText)}catch(g){f=!1}d.finish(),b(e,f?null:"could not load: "+a)}};try{c.onreadystatechange=e,c.send(null)}catch(f){b(null,"could not load: "+a)}return d},tdl.io.sendJSON=function(a,b,c){var d;if(window.XMLHttpRequest)d=new XMLHttpRequest,d.overrideMimeType&&d.overrideMimeType("text/plain");else{if(!window.ActiveXObject)throw"XMLHttpRequest is disabled";d=new ActiveXObject("MSXML2.XMLHTTP.3.0")}var e=tdl.io.createLoadInfo(d,!1);d.open("POST",a,!0);var f=JSON.stringify(b),g=function(){if(4==d.readyState){var b=void 0,f=200==d.status||0==d.status;if(f)try{b=JSON.parse(d.responseText)}catch(g){f=!1}e.finish(),c(b,f?null:"could not load: "+a)}};try{d.onreadystatechange=g,d.setRequestHeader("Content-type","application/json"),d.send(f)}catch(h){c(null,"could not load: "+a)}return e},tdl.io}),define(["./base-rs","./io"],function(){return tdl.provide("tdl.loader"),tdl.loader=tdl.loader||{},tdl.loader.Loader=function(a){this.count_=1,this.onFinished_=a,this.loadInfo=tdl.io.createLoadInfo()},tdl.loader.createLoader=function(a){return new tdl.loader.Loader(a)},tdl.loader.Loader.prototype.loadTextFile=function(a,b){var c=this;++this.count_;var d=tdl.io.loadTextFile(a,function(a,d){b(a,d),c.countDown_()});this.loadInfo.addChild(d)},tdl.loader.Loader.prototype.createLoader=function(a){var b=this;++this.count_;var c=tdl.loader.createLoader(function(){a(),b.countDown_()});return this.loadInfo.addChild(c.loadInfo),c},tdl.loader.Loader.prototype.countDown_=function(){--this.count_,0===this.count_&&this.onFinished_()},tdl.loader.Loader.prototype.finish=function(){this.countDown_()},tdl.loader}),define(["./base-rs","./string"],function(){return tdl.provide("tdl.log"),tdl.log=function(){var a=tdl.string.argsToString(arguments);window.console&&window.console.log?window.console.log(a):window.dump&&window.dump(a+"\n")},tdl.error=function(){var a=tdl.string.argsToString(arguments);window.console?window.console.error?window.console.error(a):window.console.log&&window.console.log(a):window.dump&&window.dump(a+"\n")},tdl.dumpObj=function(a,b){tdl.log(tdl.string.objToString(a,b))},tdl}),define(["./base-rs"],function(){return tdl.provide("tdl.math"),tdl.math=tdl.math||{},tdl.math.randomSeed_=0,tdl.math.RANDOM_RANGE_=Math.pow(2,32),tdl.math.matrix4=tdl.math.matrix4||{},tdl.math.rowMajor=tdl.math.rowMajor||{},tdl.math.columnMajor=tdl.math.columnMajor||{},tdl.math.pseudoRandom=function(){var a=tdl.math;return(a.randomSeed_=(134775813*a.randomSeed_+1)%a.RANDOM_RANGE_)/a.RANDOM_RANGE_},tdl.math.resetPseudoRandom=function(){tdl.math.randomSeed_=0},tdl.math.randomInt=function(a){return Math.floor(Math.random()*a)},tdl.math.degToRad=function(a){return a*Math.PI/180},tdl.math.radToDeg=function(a){return 180*a/Math.PI},tdl.math.lerpScalar=function(a,b,c){return(1-c)*a+c*b},tdl.math.addVector=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]+b[e];return c},tdl.math.subVector=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]-b[e];
return c},tdl.math.lerpVector=function(a,b,c){for(var d=[],e=a.length,f=0;e>f;++f)d[f]=(1-c)*a[f]+c*b[f];return d},tdl.math.modClamp=function(a,b,c){var d=c||0;return 1e-5>b?d:(a-=d,0>a?a-=Math.floor(a/b)*b:a%=b,a+d)},tdl.math.lerpCircular=function(a,b,c,d){a=tdl.math.modClamp(a,d),b=tdl.math.modClamp(b,d);var e=b-a;return Math.abs(e)>.5*d&&(e>0?b-=d:b+=d),tdl.math.modClamp(tdl.math.lerpScalar(a,b,c),d)},tdl.math.lerpRadian=function(a,b,c){return tdl.math.lerpCircular(a,b,c,2*Math.PI)},tdl.math.divVectorScalar=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]/b;return c},tdl.math.dot=function(a,b){for(var c=0,d=a.length,e=0;d>e;++e)c+=a[e]*b[e];return c},tdl.math.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},tdl.math.length=function(a){for(var b=0,c=a.length,d=0;c>d;++d)b+=a[d]*a[d];return Math.sqrt(b)},tdl.math.lengthSquared=function(a){for(var b=0,c=a.length,d=0;c>d;++d)b+=a[d]*a[d];return b},tdl.math.distance=function(a,b){for(var c=0,d=a.length,e=0;d>e;++e){var f=a[e]-b[e];c+=f*f}return Math.sqrt(c)},tdl.math.distanceSquared=function(a,b){for(var c=0,d=a.length,e=0;d>e;++e){var f=a[e]-b[e];c+=f*f}return c},tdl.math.normalize=function(a){for(var b=[],c=0,d=a.length,e=0;d>e;++e)c+=a[e]*a[e];if(c=Math.sqrt(c),c>1e-5)for(var e=0;d>e;++e)b[e]=a[e]/c;else b=[0,0,0];return b},tdl.math.addMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;d>f;++f){for(var g=[],h=a[f],i=b[f],j=0;e>j;++j)g[j]=h[j]+i[j];c[f]=g}return c},tdl.math.subMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;d>f;++f){for(var g=[],h=a[f],i=b[f],j=0;e>j;++j)g[j]=h[j]-i[j];c[f]=g}return c},tdl.math.lerpMatrix=function(a,b,c){for(var d=[],e=a.length,f=0;e>f;++f)d[f]=(1-c)*a[f]+c*b[f];return d},tdl.math.divMatrixScalar=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]/b;return c},tdl.math.negativeScalar=function(a){return-a},tdl.math.negativeVector=function(a){for(var b=[],c=a.length,d=0;c>d;++d)b[d]=-a[d];return b},tdl.math.negativeMatrix=function(a){for(var b=[],c=a.length,d=0;c>d;++d)b[d]=-a[d];return b},tdl.math.copyScalar=function(a){return a},tdl.math.copyVector=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b},tdl.math.copyMatrix=function(a){for(var b=[],c=a.length,d=0;c>d;++d)b[d]=a[d];return b},tdl.math.mulScalarScalar=function(a,b){return a*b},tdl.math.mulScalarVector=function(a,b){for(var c=[],d=b.length,e=0;d>e;++e)c[e]=a*b[e];return c},tdl.math.mulVectorScalar=function(a,b){return tdl.math.mulScalarVector(b,a)},tdl.math.mulScalarMatrix=function(a,b){for(var c=[],d=b.length,e=0;d>e;++e)c[e]=a*b[e];return c},tdl.math.mulMatrixScalar=function(a,b){return tdl.math.mulScalarMatrix(b,a)},tdl.math.mulVectorVector=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]*b[e];return c},tdl.math.divVectorVector=function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)c[e]=a[e]/b[e];return c},tdl.math.rowMajor.mulVectorMatrix4=function(a,b){for(var c=[],d=0;4>d;++d){c[d]=0;for(var e=0;4>e;++e)c[d]+=a[e]*b[4*e+d]}return c},tdl.math.columnMajor.mulVectorMatrix=function(a){for(var b=[],c=0;4>c;++c){b[c]=0;for(var d=0;4>d;++d)b[c]+=a[d]*b[4*c+d]}return b},tdl.math.mulVectorMatrix=null,tdl.math.rowMajor.mulMatrixVector=function(a,b){for(var c=[],d=0;4>d;++d){c[d]=0;for(var e=0;4>e;++e)c[d]+=a[4*d+e]*b[e]}return c},tdl.math.columnMajor.mulMatrixVector=function(a,b){for(var c=[],d=0;4>d;++d){c[d]=0;for(var e=0;4>e;++e)c[d]+=b[e]*a[4*e+d]}return c},tdl.math.mulMatrixVector=null,tdl.math.rowMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];return[c*g+d*i,c*h+d*j,e*g+f*i,e*h+f*j]},tdl.math.columnMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];return[c*g+e*h,d*g+f*h,c*i+e*j,d*i+f*j]},tdl.math.mulMatrixMatrix2=null,tdl.math.rowMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],n=b[2],o=b[3],p=b[4],q=b[5],r=b[6],s=b[7],t=b[8];return[c*l+d*o+e*r,c*m+d*p+e*s,c*n+d*q+e*t,f*l+g*o+h*r,f*m+g*p+h*s,f*n+g*q+h*t,i*l+j*o+k*r,i*m+j*p+k*s,i*n+j*q+k*t]},tdl.math.columnMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],n=b[2],o=b[3],p=b[4],q=b[5],r=b[6],s=b[7],t=b[8];return[c*l+f*m+i*n,d*l+g*m+j*n,e*l+h*m+k*n,c*o+f*p+i*q,d*o+g*p+j*q,e*o+h*p+k*q,c*r+f*s+i*t,d*r+g*s+j*t,e*r+h*s+k*t]},tdl.math.mulMatrixMatrix3=null,tdl.math.rowMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H]},tdl.math.columnMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+g*t+k*u+o*v,d*s+h*t+l*u+p*v,e*s+i*t+m*u+q*v,f*s+j*t+n*u+r*v,c*w+g*x+k*y+o*z,d*w+h*x+l*y+p*z,e*w+i*x+m*y+q*z,f*w+j*x+n*y+r*z,c*A+g*B+k*C+o*D,d*A+h*B+l*C+p*D,e*A+i*B+m*C+q*D,f*A+j*B+n*C+r*D,c*E+g*F+k*G+o*H,d*E+h*F+l*G+p*H,e*E+i*F+m*G+q*H,f*E+j*F+n*G+r*H]},tdl.math.mulMatrixMatrix4=null,tdl.math.rowMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=0;4>e;++e){c[4*d+e]=0;for(var f=0;4>f;++f)c[4*d+e]+=a[4*d+f]*b[4*f+e]}return c},tdl.math.columnMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=0;4>e;++e){c[4*d+e]=0;for(var f=0;4>f;++f)c[4*d+e]+=b[4*d+f]*a[4*f+e]}return c},tdl.math.mulMatrixMatrix=null,tdl.math.rowMajor.column=function(a,b){for(var c=[],d=0;4>d;++d)c[d]=a[4*d+b];return c},tdl.math.columnMajor.column=function(a,b){for(var c=[],d=0;4>d;++d)c[d]=a[4*b+d];return c},tdl.math.column=null,tdl.math.rowMajor.row=function(a,b){for(var c=[],d=0;4>d;++d)c[b]=a[4*b+d];return c},tdl.math.columnMajor.row=function(a,b,c){c=c||4;for(var d=[],e=0;c>e;++e)d[e]=a[e*c+b];return d},tdl.math.row=null,tdl.math.transpose=function(a){var b=[],c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15];return b[0]=c,b[1]=g,b[2]=k,b[3]=o,b[4]=d,b[5]=h,b[6]=l,b[7]=p,b[8]=e,b[9]=i,b[10]=m,b[11]=q,b[12]=f,b[13]=j,b[14]=n,b[15]=r,b},tdl.math.trace=function(a){for(var b=0,c=0;4>c;++c)b+=a[4*c+c];return b},tdl.math.det1=function(a){return a[0]},tdl.math.det2=function(a){return a[0]*a[3]-a[1]*a[2]},tdl.math.det3=function(a){return a[8]*(a[0]*a[4]-a[1]*a[3])-a[7]*(a[0]*a[5]-a[2]*a[3])+a[6]*(a[1]*a[5]-a[2]*a[4])},tdl.math.det4=function(a){var b=a[0]*a[5]-a[1]*a[4],c=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],f=a[1]*a[7]-a[3]*a[5],g=a[2]*a[7]-a[3]*a[6];return a[15]*(a[10]*b-a[9]*c+a[8]*e)-a[14]*(a[11]*b-a[9]*d+a[8]*f)+a[13]*(a[11]*c-a[10]*d+a[8]*g)-a[12]*(a[11]*e-a[10]*f+a[9]*g)},tdl.math.inverse1=function(a){return[[1/a[0]]]},tdl.math.inverse2=function(a){var b=1/(a[0]*a[3]-a[1]*a[2]);return[b*a[3],-b*a[1],-b*a[2],b*a[0]]},tdl.math.inverse3=function(a){var b=a[4]*a[8]-a[5]*a[7],c=a[1]*a[8]-a[2]*a[7],d=a[1]*a[5]-a[2]*a[4],e=1/(a[0]*b-a[3]*c+a[6]*d);return[e*b,-e*c,e*d,-e*(a[3]*a[8]-a[5]*a[6]),e*(a[0]*a[8]-a[2]*a[6]),-e*(a[0]*a[5]-a[2]*a[3]),e*(a[3]*a[7]-a[4]*a[6]),-e*(a[0]*a[7]-a[1]*a[6]),e*(a[0]*a[4]-a[1]*a[3])]},tdl.math.inverse4=function(a){var b=a[10]*a[15],c=a[14]*a[11],d=a[6]*a[15],e=a[14]*a[7],f=a[6]*a[11],g=a[10]*a[7],h=a[2]*a[15],i=a[14]*a[3],j=a[2]*a[11],k=a[10]*a[3],l=a[2]*a[7],m=a[6]*a[3],n=a[8]*a[13],o=a[12]*a[9],p=a[4]*a[13],q=a[12]*a[5],r=a[4]*a[9],s=a[8]*a[5],t=a[0]*a[13],u=a[12]*a[1],v=a[0]*a[9],w=a[8]*a[1],x=a[0]*a[5],y=a[4]*a[1],z=b*a[5]+e*a[9]+f*a[13]-(c*a[5]+d*a[9]+g*a[13]),A=c*a[1]+h*a[9]+k*a[13]-(b*a[1]+i*a[9]+j*a[13]),B=d*a[1]+i*a[5]+l*a[13]-(e*a[1]+h*a[5]+m*a[13]),C=g*a[1]+j*a[5]+m*a[9]-(f*a[1]+k*a[5]+l*a[9]),D=1/(a[0]*z+a[4]*A+a[8]*B+a[12]*C);return[D*z,D*A,D*B,D*C,D*(c*a[4]+d*a[8]+g*a[12]-(b*a[4]+e*a[8]+f*a[12])),D*(b*a[0]+i*a[8]+j*a[12]-(c*a[0]+h*a[8]+k*a[12])),D*(e*a[0]+h*a[4]+m*a[12]-(d*a[0]+i*a[4]+l*a[12])),D*(f*a[0]+k*a[4]+l*a[8]-(g*a[0]+j*a[4]+m*a[8])),D*(n*a[7]+q*a[11]+r*a[15]-(o*a[7]+p*a[11]+s*a[15])),D*(o*a[3]+t*a[11]+w*a[15]-(n*a[3]+u*a[11]+v*a[15])),D*(p*a[3]+u*a[7]+x*a[15]-(q*a[3]+t*a[7]+y*a[15])),D*(s*a[3]+v*a[7]+y*a[11]-(r*a[3]+w*a[7]+x*a[11])),D*(p*a[10]+s*a[14]+o*a[6]-(r*a[14]+n*a[6]+q*a[10])),D*(v*a[14]+n*a[2]+u*a[10]-(t*a[10]+w*a[14]+o*a[2])),D*(t*a[6]+y*a[14]+q*a[2]-(x*a[14]+p*a[2]+u*a[6])),D*(x*a[10]+r*a[2]+w*a[6]-(v*a[6]+y*a[10]+s*a[2]))]},tdl.math.codet=function(a,b,c){for(var d=4,e=[],f=0,g=0;d-1>g;++g){f==b&&f++;for(var h=0,i=0;d-1>i;++i)h==c&&h++,e[4*g+i]=a[4*f+h],h++;f++}return tdl.math.det(e)},tdl.math.det=function(a){var b=4;if(4>=b)return tdl.math["det"+b](a);for(var c=0,d=1,e=a[0],f=a.length,g=0;f>g;g++)c+=d*e[g]*tdl.math.codet(a,0,g),d*=-1;return c},tdl.math.inverse=function(a){var b=4;if(4>=b)return tdl.math["inverse"+b](a);for(var c=[],d=a.length,e=0;d>e;++e){c[e]=[];for(var f=0;d>f;++f)c[e][f]=((f+e)%2?-1:1)*tdl.math.codet(a,f,e)}return tdl.math.divMatrixScalar(c,tdl.math.det(a))},tdl.math.orthonormalize=function(){},tdl.math.matrix4.inverse=function(a){return tdl.math.inverse4(a)},tdl.math.matrix4.mul=function(a,b){return tdl.math.mulMatrixMatrix4(a,b)},tdl.math.matrix4.det=function(a){return tdl.math.det4(a)},tdl.math.matrix4.copy=function(a){return tdl.math.copyMatrix(a)},tdl.math.matrix4.transpose=tdl.math.transpose,tdl.math.matrix4.setUpper3x3=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[4]=b[3],a[5]=b[4],a[6]=b[5],a[8]=b[6],a[9]=b[7],a[10]=b[8],a},tdl.math.matrix4.getUpper3x3=function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},tdl.math.matrix4.setTranslation=function(a,b){return a[12]=b[0],a[13]=b[1],a[14]=b[2],a[15]=1,a},tdl.math.matrix4.getTranslation=function(a){return[a[12],a[13],a[14],a[15]]},tdl.math.matrix4.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*a[3]+d*a[7]+e*a[11]+a[15];return[(c*a[0]+d*a[4]+e*a[8]+a[12])/f,(c*a[1]+d*a[5]+e*a[9]+a[13])/f,(c*a[2]+d*a[6]+e*a[10]+a[14])/f]},tdl.math.matrix4.transformVector4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[c*a[0]+d*a[4]+e*a[8]+f*a[12],c*a[1]+d*a[5]+e*a[9]+f*a[13],c*a[2]+d*a[6]+e*a[10]+f*a[14],c*a[3]+d*a[7]+e*a[11]+f*a[15]]},tdl.math.matrix4.transformDirection=function(a,b){var c=b[0],d=b[1],e=b[2];return[c*a[0]+d*a[4]+e*a[8],c*a[1]+d*a[5]+e*a[9],c*a[2]+d*a[6]+e*a[10]]},tdl.math.matrix4.transformNormal=function(a,b){var c=tdl.math.inverse4(a),d=b[0],e=b[1],f=b[2];return[d*c[0]+e*c[1]+f*c[2],d*c[4]+e*c[5]+f*c[6],d*c[8]+e*c[9]+f*c[10]]},tdl.math.matrix4.identity=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},tdl.math.matrix4.setIdentity=function(a){for(var b=0;4>b;b++)for(var c=0;4>c;c++)a[4*b+c]=b==c?1:0;return a},tdl.math.matrix4.perspective=function(a,b,c,d){var e=Math.tan(.5*Math.PI-.5*a),f=1/(c-d);return[e/b,0,0,0,0,e,0,0,0,0,(c+d)*f,-1,0,0,c*d*f*2,0]},tdl.math.matrix4.orthographic=function(a,b,c,d,e,f){return[2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,1/(e-f),0,(a+b)/(a-b),(c+d)/(c-d),e/(e-f),1]},tdl.math.matrix4.frustum=function(a,b,c,d,e,f){var g=b-a,h=d-c,i=e-f;return[2*e/g,0,0,0,0,2*e/h,0,0,(a+b)/g,(d+c)/h,f/i,-1,0,0,e*f/i,0]},tdl.math.matrix4.lookAt=function(a,b,c){return tdl.math.inverse(tdl.math.matrix4.cameraLookAt(a,b,c))},tdl.math.matrix4.cameraLookAt=function(a,b,c){var d=tdl.math.normalize(tdl.math.subVector(a,b)),e=tdl.math.normalize(tdl.math.cross(c,d)),f=tdl.math.cross(d,e);return tdl.math.inverse([e[0],e[1],e[2],0,f[0],f[1],f[2],0,d[0],d[1],d[2],0,-tdl.math.dot(e,a),-tdl.math.dot(f,a),-tdl.math.dot(d,a),1])},tdl.math.matrix4.composition=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+g*t+k*u+o*v,d*s+h*t+l*u+p*v,e*s+i*t+m*u+q*v,f*s+j*t+n*u+r*v,c*w+g*x+k*y+o*z,d*w+h*x+l*y+p*z,e*w+i*x+m*y+q*z,f*w+j*x+n*y+r*z,c*A+g*B+k*C+o*D,d*A+h*B+l*C+p*D,e*A+i*B+m*C+q*D,f*A+j*B+n*C+r*D,c*E+g*F+k*G+o*H,d*E+h*F+l*G+p*H,e*E+i*F+m*G+q*H,f*E+j*F+n*G+r*H]},tdl.math.matrix4.compose=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return a[0]=c*s+g*t+k*u+o*v,a[1]=d*s+h*t+l*u+p*v,a[2]=e*s+i*t+m*u+q*v,a[3]=f*s+j*t+n*u+r*v,a[4]=c*w+g*x+k*y+o*z,a[5]=d*w+h*x+l*y+p*z,a[6]=e*w+i*x+m*y+q*z,a[7]=f*w+j*x+n*y+r*z,a[8]=c*A+g*B+k*C+o*D,a[9]=d*A+h*B+l*C+p*D,a[10]=e*A+i*B+m*C+q*D,a[11]=f*A+j*B+n*C+r*D,a[12]=c*E+g*F+k*G+o*H,a[13]=d*E+h*F+l*G+p*H,a[14]=e*E+i*F+m*G+q*H,a[15]=f*E+j*F+n*G+r*H,a},tdl.math.matrix4.translation=function(a){return[1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1]},tdl.math.matrix4.translate=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2];return a[12]=c*s+g*t+k*u+o,a[13]=d*s+h*t+l*u+p,a[14]=e*s+i*t+m*u+q,a[15]=f*s+j*t+n*u+r,a},tdl.math.matrix4.scaling=function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},tdl.math.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c*a[0],a[1]=c*a[1],a[2]=c*a[2],a[3]=c*a[3],a[4]=d*a[4],a[5]=d*a[5],a[6]=d*a[6],a[7]=d*a[7],a[8]=e*a[8],a[9]=e*a[9],a[10]=e*a[10],a[11]=e*a[11],a},tdl.math.matrix4.rotationX=function(a){var b=Math.cos(a),c=Math.sin(a);return[1,0,0,0,0,b,c,0,0,-c,b,0,0,0,0,1]},tdl.math.matrix4.rotateX=function(a,b){var c=a[4],d=a[5],e=a[6],f=a[7],g=a[8],h=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);return a[4]=k*c+l*g,a[5]=k*d+l*h,a[6]=k*e+l*i,a[7]=k*f+l*j,a[8]=k*g-l*c,a[9]=k*h-l*d,a[10]=k*i-l*e,a[11]=k*j-l*f,a},tdl.math.matrix4.rotationY=function(a){var b=Math.cos(a),c=Math.sin(a);return[b,0,-c,0,0,1,0,0,c,0,b,0,0,0,0,1]},tdl.math.matrix4.rotateY=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[8],h=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);return a[0]=k*c-l*g,a[1]=k*d-l*h,a[2]=k*e-l*i,a[3]=k*f-l*j,a[8]=k*g+l*c,a[9]=k*h+l*d,a[10]=k*i+l*e,a[11]=k*j+l*f,a},tdl.math.matrix4.rotationZ=function(a){var b=Math.cos(a),c=Math.sin(a);return[b,c,0,0,-c,b,0,0,0,0,1,0,0,0,0,1]},tdl.math.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=Math.cos(b),l=Math.sin(b);return a[0]=k*c+l*g,a[1]=k*d+l*h,a[2]=k*e+l*i,a[3]=k*f+l*j,a[4]=k*g-l*c,a[5]=k*h-l*d,a[6]=k*i-l*e,a[7]=k*j-l*f,a},tdl.math.matrix4.rotationZYX=function(a){var b=Math.sin(a[0]),c=Math.cos(a[0]),d=Math.sin(a[1]),e=Math.cos(a[1]),f=Math.sin(a[2]),g=Math.cos(a[2]),h=g*d,i=f*d;return[g*e,f*e,-d,0,h*b-f*c,i*b+g*c,e*b,0,h*c+f*b,i*c-g*b,e*c,0,0,0,0,1]},tdl.math.matrix4.rotateZYX=function(a,b){{var c=Math.sin(b[0]),d=Math.cos(b[0]),e=Math.sin(b[1]),f=Math.cos(b[1]),g=Math.sin(b[2]),h=Math.cos(b[2]),i=h*e,j=g*e,k=h*f,l=g*f,m=-e,n=i*c-g*d,o=j*c+h*d,p=f*c,q=i*d+g*c,r=j*d-h*c,s=f*d,t=a[0],u=a[1],v=a[2],w=a[3],x=a[4],y=a[5],z=a[6],A=a[7],B=a[8],C=a[9],D=a[10],E=a[11];a[12],a[13],a[14],a[15]}return a[0]=k*t+l*x+m*B,a[1]=k*u+l*y+m*C,a[2]=k*v+l*z+m*D,a[3]=k*w+l*A+m*E,a[4]=n*t+o*x+p*B,a[5]=n*u+o*y+p*C,a[6]=n*v+o*z+p*D,a[7]=n*w+o*A+p*E,a[8]=q*t+r*x+s*B,a[9]=q*u+r*y+s*C,a[10]=q*v+r*z+s*D,a[11]=q*w+r*A+s*E,a},tdl.math.matrix4.axisRotation=function(a,b){var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);c/=f,d/=f,e/=f;var g=c*c,h=d*d,i=e*e,j=Math.cos(b),k=Math.sin(b),l=1-j;return[g+(1-g)*j,c*d*l+e*k,c*e*l-d*k,0,c*d*l-e*k,h+(1-h)*j,d*e*l+c*k,0,c*e*l+d*k,d*e*l-c*k,i+(1-i)*j,0,0,0,0,1]},tdl.math.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=Math.sqrt(d*d+e*e+f*f);d/=g,e/=g,f/=g;{var h=d*d,i=e*e,j=f*f,k=Math.cos(c),l=Math.sin(c),m=1-k,n=h+(1-h)*k,o=d*e*m+f*l,p=d*f*m-e*l,q=d*e*m-f*l,r=i+(1-i)*k,s=e*f*m+d*l,t=d*f*m+e*l,u=e*f*m-d*l,v=j+(1-j)*k,w=a[0],x=a[1],y=a[2],z=a[3],A=a[4],B=a[5],C=a[6],D=a[7],E=a[8],F=a[9],G=a[10],H=a[11];a[12],a[13],a[14],a[15]}return a[0]=n*w+o*A+p*E,a[1]=n*x+o*B+p*F,a[2]=n*y+o*C+p*G,a[3]=n*z+o*D+p*H,a[4]=q*w+r*A+s*E,a[5]=q*x+r*B+s*F,a[6]=q*y+r*C+s*G,a[7]=q*z+r*D+s*H,a[8]=t*w+u*A+v*E,a[9]=t*x+u*B+v*F,a[10]=t*y+u*C+v*G,a[11]=t*z+u*D+v*H,a},tdl.math.installRowMajorFunctions=function(){for(var a in tdl.math.rowMajor)tdl.math[a]=tdl.math.rowMajor[a]},tdl.math.installColumnMajorFunctions=function(){for(var a in tdl.math.columnMajor)tdl.math[a]=tdl.math.columnMajor[a]},tdl.math.installErrorCheckFunctions=function(){for(var a in tdl.math.errorCheck)tdl.math[a]=tdl.math.errorCheck[a]},tdl.math.installErrorCheckFreeFunctions=function(){for(var a in tdl.math.errorCheckFree)tdl.math[a]=tdl.math.errorCheckFree[a]},tdl.math.installRowMajorFunctions(),tdl.math.installErrorCheckFunctions(),tdl.math}),define(["./base-rs","./log"],function(){return tdl.provide("tdl.misc"),tdl.misc=tdl.misc||{},tdl.misc.parseUnquotedJSObjectString=function(a){var b=a.replace(/([a-zA-Z0-9_]+):/g,'"$1":');return JSON.parse(b)},tdl.misc.applyUrlSettings=function(a,b){var c=b||"settings";try{var d=window.location.href,e=d.indexOf("?"),f=d.indexOf("#");0>f&&(f=d.length);for(var g=d.substring(e+1,f),h=g.split("&"),i=0;i<h.length;++i){var j=h[i].split("="),k=j[0],l=decodeURIComponent(j[1]);switch(k){case c:var m=tdl.misc.parseUnquotedJSObjectString(l);tdl.misc.copyProperties(m,a)}}}catch(f){return tdl.error(f),void tdl.error("settings:",m)}},tdl.misc.copyProperties=function(a,b){for(var c in a){var d=a[c];if(d instanceof Array){var e=b[c];e||(e=[],b[c]=e),tdl.misc.copyProperties(d,e)}else if("object"==typeof d){var e=b[c];e||(e={},b[c]=e),tdl.misc.copyProperties(d,e)}else b[c]=d}},tdl.misc}),define(["./base-rs","./buffers"],function(){return tdl.provide("tdl.models"),tdl.models=tdl.models||{},tdl.models.Model=function(a,b,c,d){this.buffers={},this.setBuffers(b);var e={},f=0;for(var g in a.textures)e[g]=f++;this.mode=void 0===d?gl.TRIANGLES:d,this.textures=c,this.textureUnits=e,this.setProgram(a)},tdl.models.Model.prototype.setProgram=function(a){this.program=a},tdl.models.Model.prototype.setBuffer=function(a,b,c){var d="indices"==a?gl.ELEMENT_ARRAY_BUFFER:gl.ARRAY_BUFFER,e=this.buffers[a];!e||c?e=new tdl.buffers.Buffer(b,d):e.set(b),this.buffers[a]=e},tdl.models.Model.prototype.setBuffers=function(a,b){var c=this;for(var d in a)this.setBuffer(d,a[d],b);if(this.buffers.indices)this.baseBuffer=this.buffers.indices,this.drawFunc=function(a,b){gl.drawElements(c.mode,a,gl.UNSIGNED_SHORT,b)};else{for(var e in this.buffers){this.baseBuffer=this.buffers[e];break}this.drawFunc=function(a,b){gl.drawArrays(c.mode,b,a)}}},tdl.models.Model.prototype.applyUniforms_=function(a){a&&this.program.applyUniforms(a)},tdl.models.Model.prototype.drawPrep=function(){var a=this.program,b=this.buffers,c=this.textures;a.use();for(var d in b){var e=b[d];if("indices"==d)gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.buffer());else{var f=a.attrib[d];f&&f(e)}}this.applyUniforms_(c);for(var g=0;g<arguments.length;++g)this.applyUniforms_(arguments[g])},tdl.models.Model.prototype.draw=function(){for(var a=this.buffers,b=a.indices?a.indices.totalComponents():a.position.numElements(),c=0,d=0;d<arguments.length;++d){var e=arguments[d];if("number"==typeof e)switch(d){case 0:b=e;break;case 1:c=e;break;default:throw"unvalid argument"}else this.applyUniforms_(e)}this.drawFunc(b,c)},tdl.models}),define(["./base-rs","./math","./shader"],function(){return tdl.provide("tdl.particles"),tdl.particles=tdl.particles||{},tdl.particles.ParticleStateIds={BLEND:0,ADD:1,BLEND_PREMULTIPLY:2,BLEND_NO_ALPHA:3,SUBTRACT:4,INVERSE:5},tdl.particles.SHADER_STRINGS=["uniform mat4 worldViewProjection;\nuniform mat4 world;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\n// Incoming vertex attributes\nattribute vec4 uvLifeTimeFrameStart; // uv, lifeTime, frameStart\nattribute vec4 positionStartTime;    // position.xyz, startTime\nattribute vec4 velocityStartSize;    // velocity.xyz, startSize\nattribute vec4 accelerationEndSize;  // acceleration.xyz, endSize\nattribute vec4 spinStartSpinSpeed;   // spinStart.x, spinSpeed.y\nattribute vec4 orientation;          // orientation quaternion\nattribute vec4 colorMult;            // multiplies color and ramp textures\n\n// Outgoing variables to fragment shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz,\n                                0.)).xyz + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world * vec4(accelerationEndSize.xyz,\n                                    0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                    numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n  outputTexcoord = vec2(u, uv.y + 0.5);\n  outputColorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0. || percentLife > 1.) ? 0. : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., \n                           (uv.x * s - uv.y * c) * size, 1.);\n  vec3 center = velocity * localTime +\n                acceleration * localTime * localTime + \n                position;\n\n  vec4 q2 = orientation + orientation;\n  vec4 qx = orientation.xxxw * q2.xyzx;\n  vec4 qy = orientation.xyyw * q2.xyzy;\n  vec4 qz = orientation.xxzw * q2.xxzz;\n\n  mat4 localMatrix = mat4(\n      (1.0 - qy.y) - qz.z, \n      qx.y + qz.w, \n      qx.z - qy.w,\n      0,\n\n      qx.y - qz.w, \n      (1.0 - qx.x) - qz.z, \n      qy.z + qx.w,\n      0,\n\n      qx.z + qy.w, \n      qy.z - qx.w, \n      (1.0 - qx.x) - qy.y,\n      0,\n\n      center.x, center.y, center.z, 1);\n  rotatedPoint = localMatrix * rotatedPoint;\n  outputPercentLife = percentLife;\n  gl_Position = worldViewProjection * rotatedPoint;\n}\n","uniform mat4 viewProjection;\nuniform mat4 world;\nuniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\n// Incoming vertex attributes\nattribute vec4 uvLifeTimeFrameStart; // uv, lifeTime, frameStart\nattribute vec4 positionStartTime;    // position.xyz, startTime\nattribute vec4 velocityStartSize;    // velocity.xyz, startSize\nattribute vec4 accelerationEndSize;  // acceleration.xyz, endSize\nattribute vec4 spinStartSpinSpeed;   // spinStart.x, spinSpeed.y\nattribute vec4 colorMult;            // multiplies color and ramp textures\n\n// Outgoing variables to fragment shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz,\n                                0.)).xyz + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world * vec4(accelerationEndSize.xyz,\n                                    0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                    numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n  outputTexcoord = vec2(u, uv.y + 0.5);\n  outputColorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0. || percentLife > 1.) ? 0. : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                           -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                            basisZ * rotatedPoint.y) * size +\n                       velocity * localTime +\n                       acceleration * localTime * localTime + \n                       position;\n\n  outputPercentLife = percentLife;\n  gl_Position = viewProjection * vec4(localPosition + world[3].xyz, 1.);\n}\n","#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\n// Incoming variables from vertex shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n                             vec2(outputPercentLife, 0.5)) *\n                   outputColorMult;\n  gl_FragColor = texture2D(colorSampler, outputTexcoord) * colorMult;\n}\n"],tdl.particles.CORNERS_=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],tdl.particles.ParticleSystem=function(a,b,c){this.gl=a,this.drawables_=[];var d=[];d.push(new tdl.shader.Shader(a,tdl.particles.SHADER_STRINGS[0],tdl.particles.SHADER_STRINGS[2])),d.push(new tdl.shader.Shader(a,tdl.particles.SHADER_STRINGS[1],tdl.particles.SHADER_STRINGS[2]));var e={};e[tdl.particles.ParticleStateIds.BLEND]={src:a.SRC_ALPHA,dest:a.ONE_MINUS_SRC_ALPHA},e[tdl.particles.ParticleStateIds.ADD]={src:a.SRC_ALPHA,dest:a.ONE},e[tdl.particles.ParticleStateIds.BLEND_PREMULTIPLY]={src:a.ONE,dest:a.ONE_MINUS_SRC_ALPHA},e[tdl.particles.ParticleStateIds.BLEND_NO_ALPHA]={src:a.SRC_COLOR,dest:a.ONE_MINUS_SRC_COLOR},e[tdl.particles.ParticleStateIds.SUBTRACT]={src:a.SRC_ALPHA,dest:a.ONE_MINUS_SRC_ALPHA,eq:a.FUNC_REVERSE_SUBTRACT},e[tdl.particles.ParticleStateIds.INVERSE]={src:a.ONE_MINUS_DST_COLOR,dest:a.ONE_MINUS_SRC_COLOR},this.blendFuncs_=e;for(var f=[0,.2,.7,1,.7,.2,0,0],g=[],h=0;8>h;++h)for(var i=0;8>i;++i){var j=f[i]*f[h];g.push(j,j,j,j)}var k=this.createTextureFromFloats(8,8,g),l=this.createTextureFromFloats(2,1,[1,1,1,1,1,1,1,0]);this.now_=new Date,this.timeBase_=new Date,this.timeSource_=b?b:tdl.particles.createDefaultClock_(this),this.randomFunction_=c||function(){return Math.random()},this.singleParticleArray_=new Float32Array(4*tdl.particles.LAST_IDX),this.shaders=d,this.defaultColorTexture=k,this.defaultRampTexture=l},tdl.particles.createDefaultClock_=function(a){return function(){var b=a.now_,c=a.timeBase_;return(b.getTime()-c.getTime())/1e3}},tdl.particles.ParticleSystem.prototype.createTextureFromFloats=function(a,b,c,d){var e=this.gl,f=null;f=null!=d?d:e.createTexture(),e.bindTexture(e.TEXTURE_2D,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);for(var g=new Uint8Array(c.length),h=0;h<c.length;h++){var i=255*c[h];g[h]=i}return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,b,0,e.RGBA,e.UNSIGNED_BYTE,g),f},tdl.particles.ParticleSpec=function(){this.numParticles=1,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.lifeTimeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.position=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.worldAcceleration=[0,0,0],this.billboard=!0,this.orientation=[0,0,0,1]},tdl.particles.ParticleSystem.prototype.createParticleEmitter=function(a,b){var c=new tdl.particles.ParticleEmitter(this,a,b);return this.drawables_.push(c),c},tdl.particles.ParticleSystem.prototype.createTrail=function(a,b,c,d,e){var f=new tdl.particles.Trail(this,a,b,c,d,e);return this.drawables_.push(f),f},tdl.particles.ParticleSystem.prototype.draw=function(a,b,c){this.now_=new Date;var d=this.gl;d.depthMask(!1),d.enable(d.DEPTH_TEST);var e=this.shaders[1];e.bind(),d.uniformMatrix4fv(e.viewProjectionLoc,!1,a),d.uniformMatrix4fv(e.viewInverseLoc,!1,c);for(var f=0;f<this.drawables_.length;++f)this.drawables_[f].draw(b,a,0)},tdl.particles.UV_LIFE_TIME_FRAME_START_IDX=0,tdl.particles.POSITION_START_TIME_IDX=4,tdl.particles.VELOCITY_START_SIZE_IDX=8,tdl.particles.ACCELERATION_END_SIZE_IDX=12,tdl.particles.SPIN_START_SPIN_SPEED_IDX=16,tdl.particles.ORIENTATION_IDX=20,tdl.particles.COLOR_MULT_IDX=24,tdl.particles.LAST_IDX=28,tdl.particles.ParticleEmitter=function(a,b,c){c=c||a.timeSource_,this.gl=a.gl,this.createdParticles_=!1,this.tmpWorld_=new Float32Array(16),this.singleParticleArray_=new Float32Array(4*tdl.particles.LAST_IDX),this.particleBuffer_=gl.createBuffer(),this.indexBuffer_=gl.createBuffer(),this.numParticles_=0,this.rampTexture_=a.defaultRampTexture,this.colorTexture_=b||a.defaultColorTexture,this.particleSystem=a,this.timeSource_=c,this.translation_=[0,0,0],this.setState(tdl.particles.ParticleStateIds.BLEND)},tdl.particles.ParticleEmitter.prototype.setTranslation=function(a,b,c){this.translation_[0]=a,this.translation_[1]=b,this.translation_[2]=c},tdl.particles.ParticleEmitter.prototype.setState=function(a){this.blendFunc_=this.particleSystem.blendFuncs_[a]},tdl.particles.ParticleEmitter.prototype.setColorRamp=function(a){var b=a.length/4;if(b%1!=0)throw"colorRamp must have multiple of 4 entries";this.rampTexture_==this.particleSystem.defaultRampTexture&&(this.rampTexture_=null),this.rampTexture_=this.particleSystem.createTextureFromFloats(b,1,a,this.rampTexture_)},tdl.particles.ParticleEmitter.prototype.validateParameters=function(a){var b=new tdl.particles.ParticleSpec;for(var c in a)if("undefined"==typeof b[c])throw'unknown particle parameter "'+c+'"';for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c])},tdl.particles.ParticleEmitter.prototype.createParticles_=function(a,b,c,d){var e=this.particleSystem.singleParticleArray_,f=this.gl;this.billboard_=c.billboard,this.timeRange_=c.timeRange||99999999,this.numFrames_=c.numFrames,this.frameDuration_=c.frameDuration,this.worldVelocity_=[c.worldVelocity[0],c.worldVelocity[1],c.worldVelocity[2]],this.worldAcceleration_=[c.worldAcceleration[0],c.worldAcceleration[1],c.worldAcceleration[2]];var g=this.particleSystem.randomFunction_,h=function(a){return(g()-.5)*a*2},i=function(a){for(var b=[],c=0;c<a.length;++c)b.push(h(a[c]));return b};f.bindBuffer(f.ARRAY_BUFFER,this.particleBuffer_);for(var j=0;b>j;++j){d&&d(j,c);for(var k=c.lifeTime,l=null===c.startTime?j*c.lifeTime/b:c.startTime,m=c.frameStart+h(c.frameStartRange),n=tdl.math.addVector(c.position,i(c.positionRange)),o=tdl.math.addVector(c.velocity,i(c.velocityRange)),p=tdl.math.addVector(c.acceleration,i(c.accelerationRange)),q=tdl.math.addVector(c.colorMult,i(c.colorMultRange)),r=c.spinStart+h(c.spinStartRange),s=c.spinSpeed+h(c.spinSpeedRange),t=c.startSize+h(c.startSizeRange),u=c.endSize+h(c.endSizeRange),v=c.orientation,w=0;4>w;++w){var x=tdl.particles.LAST_IDX*w,y=x+1,z=x+2,A=x+3;
e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+x]=tdl.particles.CORNERS_[w][0],e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+y]=tdl.particles.CORNERS_[w][1],e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+z]=k,e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+A]=m,e[tdl.particles.POSITION_START_TIME_IDX+x]=n[0],e[tdl.particles.POSITION_START_TIME_IDX+y]=n[1],e[tdl.particles.POSITION_START_TIME_IDX+z]=n[2],e[tdl.particles.POSITION_START_TIME_IDX+A]=l,e[tdl.particles.VELOCITY_START_SIZE_IDX+x]=o[0],e[tdl.particles.VELOCITY_START_SIZE_IDX+y]=o[1],e[tdl.particles.VELOCITY_START_SIZE_IDX+z]=o[2],e[tdl.particles.VELOCITY_START_SIZE_IDX+A]=t,e[tdl.particles.ACCELERATION_END_SIZE_IDX+x]=p[0],e[tdl.particles.ACCELERATION_END_SIZE_IDX+y]=p[1],e[tdl.particles.ACCELERATION_END_SIZE_IDX+z]=p[2],e[tdl.particles.ACCELERATION_END_SIZE_IDX+A]=u,e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+x]=r,e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+y]=s,e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+z]=0,e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+A]=0,e[tdl.particles.ORIENTATION_IDX+x]=v[0],e[tdl.particles.ORIENTATION_IDX+y]=v[1],e[tdl.particles.ORIENTATION_IDX+z]=v[2],e[tdl.particles.ORIENTATION_IDX+A]=v[3],e[tdl.particles.COLOR_MULT_IDX+x]=q[0],e[tdl.particles.COLOR_MULT_IDX+y]=q[1],e[tdl.particles.COLOR_MULT_IDX+z]=q[2],e[tdl.particles.COLOR_MULT_IDX+A]=q[3]}f.bufferSubData(f.ARRAY_BUFFER,e.byteLength*(j+a),e)}this.createdParticles_=!0},tdl.particles.ParticleEmitter.prototype.allocateParticles_=function(a){if(this.numParticles_!=a){var b=this.gl;b.bindBuffer(b.ARRAY_BUFFER,this.particleBuffer_),b.bufferData(b.ARRAY_BUFFER,a*this.particleSystem.singleParticleArray_.byteLength,b.DYNAMIC_DRAW);var c=6*a;if(c>65536)throw"can't have more than 10922 particles per emitter";for(var d=new Uint16Array(c),e=0,f=0;a>f;++f){var g=4*f;d[e++]=g+0,d[e++]=g+1,d[e++]=g+2,d[e++]=g+0,d[e++]=g+2,d[e++]=g+3}b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer_),b.bufferData(b.ELEMENT_ARRAY_BUFFER,d,b.STATIC_DRAW),this.numParticles_=a}},tdl.particles.ParticleEmitter.prototype.setParameters=function(a,b){this.validateParameters(a);var c=a.numParticles;this.allocateParticles_(c),this.createParticles_(0,c,a,b)},tdl.particles.ParticleEmitter.prototype.draw=function(a,b,c){if(this.createdParticles_){var d=this.gl;d.enable(d.BLEND);var e=this.blendFunc_;d.blendFunc(e.src,e.dest),d.blendEquation(e.eq?e.eq:d.FUNC_ADD);var f=this.particleSystem.shaders[this.billboard_?1:0];f.bind();var g=this.tmpWorld_;if(tdl.fast.matrix4.copy(g,a),tdl.fast.matrix4.translate(g,this.translation_),d.uniformMatrix4fv(f.worldLoc,!1,g),!this.billboard_){var h=new Float32Array(16);tdl.fast.matrix4.mul(h,g,b),d.uniformMatrix4fv(f.worldViewProjectionLoc,!1,h)}d.uniform3f(f.worldVelocityLoc,this.worldVelocity_[0],this.worldVelocity_[1],this.worldVelocity_[2]),d.uniform3f(f.worldAccelerationLoc,this.worldAcceleration_[0],this.worldAcceleration_[1],this.worldAcceleration_[2]),d.uniform1f(f.timeRangeLoc,this.timeRange_),d.uniform1f(f.numFramesLoc,this.numFrames_),d.uniform1f(f.frameDurationLoc,this.frameDuration_);var i=this.timeSource_();d.uniform1f(f.timeLoc,i),d.uniform1f(f.timeOffsetLoc,c),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,this.rampTexture_),d.uniform1i(f.rampSamplerLoc,0),d.activeTexture(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,this.colorTexture_),d.uniform1i(f.colorSamplerLoc,1),d.activeTexture(d.TEXTURE0);var j=4,k=j*tdl.particles.LAST_IDX;d.bindBuffer(d.ARRAY_BUFFER,this.particleBuffer_),d.vertexAttribPointer(f.uvLifeTimeFrameStartLoc,4,d.FLOAT,!1,k,j*tdl.particles.UV_LIFE_TIME_FRAME_START_IDX),d.enableVertexAttribArray(f.uvLifeTimeFrameStartLoc),d.vertexAttribPointer(f.positionStartTimeLoc,4,d.FLOAT,!1,k,j*tdl.particles.POSITION_START_TIME_IDX),d.enableVertexAttribArray(f.positionStartTimeLoc),d.vertexAttribPointer(f.velocityStartSizeLoc,4,d.FLOAT,!1,k,j*tdl.particles.VELOCITY_START_SIZE_IDX),d.enableVertexAttribArray(f.velocityStartSizeLoc),d.vertexAttribPointer(f.accelerationEndSizeLoc,4,d.FLOAT,!1,k,j*tdl.particles.ACCELERATION_END_SIZE_IDX),d.enableVertexAttribArray(f.accelerationEndSizeLoc),d.vertexAttribPointer(f.spinStartSpinSpeedLoc,4,d.FLOAT,!1,k,j*tdl.particles.SPIN_START_SPIN_SPEED_IDX),d.enableVertexAttribArray(f.spinStartSpinSpeedLoc),void 0!=f.orientationLoc&&(d.vertexAttribPointer(f.orientationLoc,4,d.FLOAT,!1,k,j*tdl.particles.ORIENTATION_IDX),d.enableVertexAttribArray(f.orientationLoc)),d.vertexAttribPointer(f.colorMultLoc,4,d.FLOAT,!1,k,j*tdl.particles.COLOR_MULT_IDX),d.enableVertexAttribArray(f.colorMultLoc),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.indexBuffer_),d.drawElements(d.TRIANGLES,6*this.numParticles_,d.UNSIGNED_SHORT,0),d.disableVertexAttribArray(f.uvLifeTimeFrameStartLoc),d.disableVertexAttribArray(f.positionStartTimeLoc),d.disableVertexAttribArray(f.velocityStartSizeLoc),d.disableVertexAttribArray(f.accelerationEndSizeLoc),d.disableVertexAttribArray(f.spinStartSpinSpeedLoc),void 0!=f.orientationLoc&&d.disableVertexAttribArray(f.orientationLoc),d.disableVertexAttribArray(f.colorMultLoc)}},tdl.particles.ParticleEmitter.prototype.createOneShot=function(){return new tdl.particles.OneShot(this)},tdl.particles.OneShot=function(a){this.emitter_=a,this.world_=tdl.fast.matrix4.translation(new Float32Array(16),[0,0,0]),this.tempWorld_=tdl.fast.matrix4.translation(new Float32Array(16),[0,0,0]),this.timeOffset_=0,this.visible_=!1;var b=a.particleSystem,c=b.drawables_.indexOf(a);c>=0&&b.drawables_.splice(c,1),b.drawables_.push(this)},tdl.particles.OneShot.prototype.trigger=function(a){a&&this.world_.set(a),this.visible_=!0,this.timeOffset_=this.emitter_.timeSource_()},tdl.particles.OneShot.prototype.draw=function(a,b){this.visible_&&(tdl.fast.matrix4.mul(this.tempWorld_,this.world_,a),this.emitter_.draw(this.tempWorld_,b,this.timeOffset_))},tdl.particles.Trail=function(a,b,c,d,e,f){tdl.particles.ParticleEmitter.call(this,a,d,f),this.allocateParticles_(b),this.validateParameters(c),this.parameters=c,this.perParticleParamSetter=e,this.birthIndex_=0,this.maxParticles_=b},tdl.base.inherit(tdl.particles.Trail,tdl.particles.ParticleEmitter),tdl.particles.Trail.prototype.birthParticles=function(a){var b=this.parameters.numParticles;for(this.parameters.startTime=this.timeSource_(),this.parameters.position=a;this.birthIndex_+b>=this.maxParticles_;){var c=this.maxParticles_-this.birthIndex_;this.createParticles_(this.birthIndex_,c,this.parameters,this.perParticleParamSetter),b-=c,this.birthIndex_=0}this.createParticles_(this.birthIndex_,b,this.parameters,this.perParticleParamSetter),this.birthIndex_+=b},tdl.particles.OneShotManager=function(a,b){this.numOneshots=b,this.oneshotIndex=0,this.oneshots=[];for(var c=0;b>c;++c)this.oneshots.push(a.createOneShot())},tdl.particles.OneShotManager.prototype.startOneShot=function(a){this.oneshots[this.oneshotIndex].trigger(a),this.oneshotIndex=(this.oneshotIndex+1)%this.numOneshots},tdl.particles.createOneShotManager=function(a,b){return new tdl.particles.OneShotManager(a,b)},tdl.particles}),define(["./base-rs","./math","./log"],function(){return tdl.provide("tdl.primitives"),tdl.primitives=tdl.primitives||{},tdl.primitives.AttribBuffer=function(a,b,c){c=c||"Float32Array";var d=window[c];b.length?(this.buffer=new d(b),b=this.buffer.length/a,this.cursor=b):(this.buffer=new d(a*b),this.cursor=0),this.numComponents=a,this.numElements=b,this.type=c},tdl.primitives.AttribBuffer.prototype.stride=function(){return 0},tdl.primitives.AttribBuffer.prototype.offset=function(){return 0},tdl.primitives.AttribBuffer.prototype.getElement=function(a){for(var b=a*this.numComponents,c=[],d=0;d<this.numComponents;++d)c.push(this.buffer[b+d]);return c},tdl.primitives.AttribBuffer.prototype.setElement=function(a,b){for(var c=a*this.numComponents,d=0;d<this.numComponents;++d)this.buffer[c+d]=b[d]},tdl.primitives.AttribBuffer.prototype.fillRange=function(a,b,c){for(var d=a*this.numComponents,e=0;b>e;++e)for(var f=0;f<this.numComponents;++f)this.buffer[d++]=c[f]},tdl.primitives.AttribBuffer.prototype.clone=function(){var a=new tdl.primitives.AttribBuffer(this.numComponents,this.numElements,this.type);return a.pushArray(this),a},tdl.primitives.AttribBuffer.prototype.push=function(a){this.setElement(this.cursor++,a)},tdl.primitives.AttribBuffer.prototype.pushArray=function(a){for(var b=0;b<a.numElements;++b)this.push(a.getElement(b))},tdl.primitives.AttribBuffer.prototype.pushArrayWithOffset=function(a,b){for(var c=0;c<a.numElements;++c){for(var d=a.getElement(c),e=0;e<b.length;++e)d[e]+=b[e];this.push(d)}},tdl.primitives.AttribBuffer.prototype.computeExtents=function(){for(var a=this.numElements,b=this.numComponents,c=this.getElement(0),d=this.getElement(0),e=1;a>e;++e)for(var f=this.getElement(e),g=0;b>g;++g)c[g]=Math.min(c[g],f[g]),d[g]=Math.max(d[g],f[g]);return{min:c,max:d}},tdl.primitives.mulComponents=function(a,b){for(var c=a.numElements,d=a.numComponents,e=0;c>e;++e){for(var f=a.getElement(e),g=0;d>g;++g)f[g]*=b[g];a.setElement(e,f)}},tdl.primitives.reorientPositions=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;d>e;++e)a.setElement(e,c.matrix4.transformPoint(b,a.getElement(e)))},tdl.primitives.reorientNormals=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;d>e;++e)a.setElement(e,c.matrix4.transformNormal(b,a.getElement(e)))},tdl.primitives.reorientDirections=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;d>e;++e)a.setElement(e,c.matrix4.transformDirection(b,a.getElement(e)))},tdl.primitives.reorient=function(a,b){for(var c in a)c.match(/^position/)?tdl.primitives.reorientPositions(a[c],b):c.match(/^normal/)?tdl.primitives.reorientNormals(a[c],b):(c.match(/^tangent/)||c.match(/^binormal/))&&tdl.primitives.reorientDirections(a[c],b)},tdl.primitives.createTangentsAndBinormals=function(a,b,c,d){function e(a){return[Math.round(a[0]),Math.round(a[1]),Math.round(a[2])]}function f(a,b){return e(i.mulVectorScalar(a,100))+","+e(i.mulVectorScalar(b,100))}function g(a,b,c,d){var e=f(a,b),g=j[e];g||(g=[[0,0,0],[0,0,0]]),g[0]=i.addVector(g[0],c),g[1]=i.addVector(g[1],d),j[e]=g}function h(a,b){var c=f(a,b);return j[c]}for(var i=tdl.math,j={},k=d.numElements,l=0;k>l;++l){for(var m=d.getElement(l),n=[],o=[],p=[],q=0;3>q;++q){var r=m[q];n[q]=c.getElement(r),o[q]=a.getElement(r),p[q]=b.getElement(r)}for(var s=[0,0,0],t=[0,0,0],u=0;3>u;++u){var v=[o[1][u]-o[0][u],n[1][0]-n[0][0],n[1][1]-n[0][1]],w=[o[2][u]-o[0][u],n[2][0]-n[0][0],n[2][1]-n[0][1]],x=i.normalize(i.cross(v,w));0==x[0]&&(x[0]=1),s[u]=-x[1]/x[0],t[u]=-x[2]/x[0]}var y=i.length(s);y>1e-5&&(s=i.mulVectorScalar(s,1/y));var z=i.length(t);z>1e-5&&(t=i.mulVectorScalar(t,1/z));for(var q=0;3>q;++q)g(o[q],p[q],s,t)}for(var A=a.numElements,B=new tdl.primitives.AttribBuffer(3,A),C=new tdl.primitives.AttribBuffer(3,A),r=0;A>r;++r){var D=a.getElement(r),E=b.getElement(r),F=h(D,E),s=F[0];s=i.subVector(s,i.mulVectorScalar(E,i.dot(E,s)));var y=i.length(s);y>1e-5&&(s=i.mulVectorScalar(s,1/y));var t=F[1];t=i.subVector(t,i.mulVectorScalar(s,i.dot(s,t))),t=i.subVector(t,i.mulVectorScalar(E,i.dot(E,t)));var z=i.length(t);z>1e-5&&(t=i.mulVectorScalar(t,1/z)),B.push(s),C.push(t)}return{tangent:B,binormal:C}},tdl.primitives.addTangentsAndBinormals=function(a){var b=tdl.primitives.createTangentsAndBinormals(a.position,a.normal,a.texCoord,a.indices);return a.tangent=b.tangent,a.binormal=b.binormal,a},tdl.primitives.clone=function(a){var b={};for(var c in a)b[c]=a[c].clone();return b},tdl.primitives.concat=function(a){for(var b,c={},d=0;d<a.length;++d){var e=a[d];for(var f in e){c[f]||(c[f]=[]),b||"indices"==f||(b=f);var g=e[f];c[f].push(g.numElements)}}var h=c[b],i={};for(var f in c){for(var j,k,l=0,d=0;d<a.length;++d){var e=a[d],g=e[f];l+=g.numElements,j=g.numComponents,k=g.type}for(var m=new tdl.primitives.AttribBuffer(j,l,k),n=0,d=0;d<a.length;++d){var e=a[d],g=e[f];"indices"==f?(m.pushArrayWithOffset(g,[n,n,n]),n+=h[d]):m.pushArray(g)}i[f]=m}return i},tdl.primitives.concatLarge=function(a){for(var b,c=[],d=[],e=0,f=0;f<a.length;++f){var g=a[f];!b||e+g.position.numElements>65536?(e=0,b=[g],d.push(b)):b.push(g),c.push({firstVertex:e,numVertices:g.position.numElements,arrayIndex:d.length-1}),e+=g.position.numElements}for(var f=0;f<d.length;++f)d[f]=tdl.primitives.concat(d[f]);return{arrays:d,instances:c}},tdl.primitives.applyPlanarUVMapping=function(a,b){for(var c=a.computeExtents(),d=tdl.math.subVector(c.max,c.min),e=a.numElements,f=0;e>f;++f){var g=a.getElement(f),h=(g[0]-c.min[0])/d[0],i=(g[2]-c.min[2])/d[2];b.setElement(f,[h,i])}},tdl.primitives.createSphere=function(a,b,c,d,e,f,g){if(0>=b||0>=c)throw Error("subdivisionAxis and subdivisionHeight must be > 0");tdl.math;d=d||0,e=e||Math.PI,f=f||0,g=g||2*Math.PI;for(var h=e-d,i=g-f,j=(b+1)*(c+1),k=new tdl.primitives.AttribBuffer(3,j),l=new tdl.primitives.AttribBuffer(3,j),m=new tdl.primitives.AttribBuffer(2,j),n=0;c>=n;n++)for(var o=0;b>=o;o++){var p=o/b,q=n/c,r=i*p,s=h*q,t=Math.sin(r),u=Math.cos(r),v=Math.sin(s),w=Math.cos(s),x=u*v,y=w,z=t*v;k.push([a*x,a*y,a*z]),l.push([x,y,z]),m.push([1-p,q])}for(var A=b+1,B=new tdl.primitives.AttribBuffer(3,b*c*2,"Uint16Array"),o=0;b>o;o++)for(var n=0;c>n;n++)B.push([(n+0)*A+o,(n+0)*A+o+1,(n+1)*A+o]),B.push([(n+1)*A+o,(n+0)*A+o+1,(n+1)*A+o+1]);return{position:k,normal:l,texCoord:m,indices:B}},tdl.primitives.createCresent=function(a,b,c,d,e,f,g){function h(b,c,g,h,i,m){for(var q=0;e>=q;q++){var r=c/(k-1),s=q/e,t=2*(r-.5),u=(f+s*l)*Math.PI,v=Math.sin(u),w=Math.cos(u),x=j.lerpScalar(a,b,v),y=t*d,z=w*a,A=v*x;n.push([y,z,A]);var B=j.addVector(j.mulVectorVector([0,v,w],g),h);o.push(B),p.push([r*i+m,s])}}function i(a,b){for(var c=0;e>c;++c)s.push([a+c+0,a+c+1,b+c+0]),s.push([a+c+1,b+c+1,b+c+0])}if(0>=e)throw Error("subdivisionDown must be > 0");var j=tdl.math;f=f||0,g=g||1;for(var k=2,l=g-f,m=2*(e+1)*(2+k),n=new tdl.primitives.AttribBuffer(3,m),o=new tdl.primitives.AttribBuffer(3,m),p=new tdl.primitives.AttribBuffer(2,m),q=0;k>q;q++){var r=2*(q/(k-1)-.5);h(b,q,[1,1,1],[0,0,0],1,0),h(b,q,[0,0,0],[r,0,0],0,0),h(c,q,[1,1,1],[0,0,0],1,0),h(c,q,[0,0,0],[r,0,0],0,1)}var s=new tdl.primitives.AttribBuffer(3,2*e*(2+k),"Uint16Array"),t=e+1;return i(0*t,4*t),i(5*t,7*t),i(6*t,2*t),i(3*t,1*t),{position:n,normal:o,texCoord:p,indices:s}},tdl.primitives.createLine=function(a){var b=a.length,c=b/3;if(1>=c)throw Error("line coords length must be > 3");if(a.length%3!=0)throw Error("line coords length must be the multiple of 3");for(var d=(tdl.math,new tdl.primitives.AttribBuffer(3,c)),e=new tdl.primitives.AttribBuffer(3,c),f=0;b>f;f+=3)d.push([a[f],a[f+1],a[f+2]]),e.push([0,1,0]);for(var g=new tdl.primitives.AttribBuffer(2,c-1,"Uint16Array"),f=0;c-1>f;f++)g.push([f,f+1]);return{position:d,normal:e,indices:g}},tdl.primitives.createPlane=function(a,b,c,d){if(0>=c||0>=d)throw Error("subdivisionWidth and subdivisionDepth must be > 0");for(var e=(tdl.math,(c+1)*(d+1)),f=new tdl.primitives.AttribBuffer(3,e),g=new tdl.primitives.AttribBuffer(3,e),h=new tdl.primitives.AttribBuffer(2,e),i=0;d>=i;i++)for(var j=0;c>=j;j++){var k=j/c,l=i/d;f.push([a*k-.5*a,0,b*l-.5*b]),g.push([0,1,0]),h.push([k,l])}for(var m=c+1,n=new tdl.primitives.AttribBuffer(3,c*d*2,"Uint16Array"),i=0;d>i;i++)for(var j=0;c>j;j++)n.push([(i+0)*m+j,(i+1)*m+j,(i+0)*m+j+1]),n.push([(i+1)*m+j,(i+1)*m+j+1,(i+0)*m+j+1]);return{position:f,normal:g,texCoord:h,indices:n}},tdl.primitives.CUBE_FACE_INDICES_=[[3,7,5,1],[6,2,0,4],[6,7,3,2],[0,1,5,4],[7,6,4,5],[2,3,1,0]],tdl.primitives.createCube=function(a){for(var b=a/2,c=[[-b,-b,-b],[+b,-b,-b],[-b,+b,-b],[+b,+b,-b],[-b,-b,+b],[+b,-b,+b],[-b,+b,+b],[+b,+b,+b]],d=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],e=[[1,0],[0,0],[0,1],[1,1]],f=24,g=new tdl.primitives.AttribBuffer(3,f),h=new tdl.primitives.AttribBuffer(3,f),i=new tdl.primitives.AttribBuffer(2,f),j=new tdl.primitives.AttribBuffer(3,12,"Uint16Array"),k=0;6>k;++k){for(var l=tdl.primitives.CUBE_FACE_INDICES_[k],m=0;4>m;++m){var n=c[l[m]],o=d[k],p=e[m];g.push(n),h.push(o),i.push(p)}var q=4*k;j.push([q+0,q+1,q+2]),j.push([q+0,q+2,q+3])}return{position:g,normal:h,texCoord:i,indices:j}},tdl.primitives.createFlaredCube=function(a,b,c){for(var d=2*(c+1),e=new tdl.primitives.AttribBuffer(3,d),f=new tdl.primitives.AttribBuffer(3,d),g=new tdl.primitives.AttribBuffer(2,d),h=new tdl.primitives.AttribBuffer(3,2*c,"Uint16Array"),i=0;c>=i;i++)for(var j=0;1>=j;j++){var k=j,l=i/c,m=tdl.math.lerpScalar(a,b,l);e.push([m*k-.5*m,0,.7*tdl.math.lerpScalar(a,b,l)]),f.push([0,1,0]),g.push([l,k])}for(var n=2,i=0;c>i;i++)h.push([(i+0)*n,(i+1)*n,(i+0)*n+1]),h.push([(i+1)*n,(i+1)*n+1,(i+0)*n+1]);var o={position:e,normal:f,texCoord:g,indices:h};tdl.primitives.reorient(o,tdl.math.matrix4.rotationX(Math.PI/4));for(var p=[o],q=0;3>q;++q){var r=tdl.primitives.clone(o);tdl.primitives.reorient(r,tdl.math.matrix4.rotationZ(Math.PI*(q+1)/2)),p.push(r)}for(var o=tdl.primitives.concat(p),s=[o],q=0;3>q;++q){var r=tdl.primitives.clone(o);tdl.primitives.reorient(r,tdl.math.matrix4.rotationY(Math.PI*(q+1)/2)),s.push(r)}var o=tdl.primitives.concat(s);return o},tdl.primitives.createTruncatedCone=function(a,b,c,d,e,f,g){if(3>d)throw Error("radialSubdivisions must be 3 or greater");if(1>e)throw Error("verticalSubdivisions must be 1 or greater");for(var h=void 0===f?!0:f,i=void 0===g?!0:g,j=(h?2:0)+(i?2:0),k=(d+1)*(e+1+j),l=new tdl.primitives.AttribBuffer(3,k),m=new tdl.primitives.AttribBuffer(3,k),n=new tdl.primitives.AttribBuffer(2,k),o=new tdl.primitives.AttribBuffer(3,d*(e+j)*2,"Uint16Array"),p=d+1,q=Math.atan2(a-b,c),r=Math.cos(q),s=Math.sin(q),t=h?-2:0,u=e+(i?2:0),v=t;u>=v;++v){var w,x=v/e,y=c*x;0>v?(y=0,x=1,w=a):v>e?(y=c,x=1,w=b):w=a+(b-a)*(v/e),(-2==v||v==e+2)&&(w=0,x=0),y-=c/2;for(var z=0;p>z;++z){var A=Math.sin(z*Math.PI*2/d),B=Math.cos(z*Math.PI*2/d);l.push([A*w,y,B*w]),m.push([0>v||v>e?0:A*r,0>v?-1:v>e?1:s,0>v||v>e?0:B*r]),n.push([z/d,1-x])}}for(var v=0;e+j>v;++v)for(var z=0;d>z;++z)o.push([p*(v+0)+0+z,p*(v+0)+1+z,p*(v+1)+1+z]),o.push([p*(v+0)+0+z,p*(v+1)+1+z,p*(v+1)+0+z]);return{position:l,normal:m,texCoord:n,indices:o}},tdl.primitives.createCylinder=function(a,b,c,d,e,f){return tdl.primitives.createTruncatedCone(a,a,b,c,d,e,f)},tdl.primitives.createTorus=function(a,b,c,d,e,f){if(3>c)throw Error("radialSubdivisions must be 3 or greater");if(3>d)throw Error("verticalSubdivisions must be 3 or greater");for(var g=e||0,h=f||2*Math.PI,i=h-g,j=c*d,k=new tdl.primitives.AttribBuffer(3,j),l=new tdl.primitives.AttribBuffer(3,j),m=new tdl.primitives.AttribBuffer(2,j),n=new tdl.primitives.AttribBuffer(3,c*d*2,"Uint16Array"),o=0;d>o;++o)for(var p=o/d,q=p*Math.PI*2,r=Math.sin(q),s=a+r*b,t=Math.cos(q),u=t*b,v=0;c>v;++v){var w=v/c,x=g+w*i,y=Math.sin(x),z=Math.cos(x),A=y*s,B=z*s,C=y*r,D=z*r;k.push([A,u,B]),l.push([C,t,D]),m.push([w,1-p])}for(var o=0;d>o;++o)for(var v=0;c>v;++v){var E=(1+v)%c,F=(1+o)%d;n.push([c*o+v,c*F+v,c*o+E]),n.push([c*F+v,c*F+E,c*o+E])}return{position:k,normal:l,texCoord:m,indices:n}},tdl.primitives.createDisc=function(a,b,c,d,e){if(3>b)throw Error("divisions must be at least 3");for(var f=c?c:1,g=e?e:1,h=d?d:0,i=b*(f+1),j=new tdl.primitives.AttribBuffer(3,i),k=new tdl.primitives.AttribBuffer(3,i),l=new tdl.primitives.AttribBuffer(2,i),m=new tdl.primitives.AttribBuffer(3,f*b*2,"Uint16Array"),n=0,o=a-h,p=0;f>=p;++p){for(var q=h+o*Math.pow(p/f,g),r=0;b>r;++r){var s=2*Math.PI*r/b,t=q*Math.cos(s),u=q*Math.sin(s);if(j.push([t,0,u]),k.push([0,1,0]),l.push([1-r/b,p/f]),p>0){var v=n+(r+1)%b,w=n+r,x=n+r-b,y=n+(r+1)%b-b;m.push([v,w,x]),m.push([v,x,y])}}n+=b}return{position:j,normal:k,texCoord:l,indices:m}},tdl.primitives.interleaveVertexData=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].numComponents;for(var d=a[0].numElements,e=new Float32Array(b*d),f=0,g=0;d>g;g++)for(var h=0;h<a.length;h++)for(var i=a[h].getElement(g),j=0;j<a[h].numComponents;j++)e[f++]=i[j];return e},tdl.primitives}),define(["./base-rs","./log","./string","./webgl"],function(){return tdl.provide("tdl.programs"),tdl.programs=tdl.programs||{},tdl.programs.loadProgramFromScriptTags=function(a,b){var c=document.getElementById(a),d=document.getElementById(b);if(!c)throw"Can't find vertex program tag: "+a;if(!d)throw"Can't find fragment program tag: "+b;return tdl.programs.loadProgram(document.getElementById(a).text,document.getElementById(b).text)},tdl.programs.makeProgramId=function(a,b){return a+b},tdl.programs.loadProgram=function(a,b,c){var d=tdl.programs.makeProgramId(a,b);tdl.programs.init_();var e=gl.tdl.programs.programDB[d];if(e)return c&&setTimeout(function(){c()},1),e;try{e=new tdl.programs.Program(a,b,c)}catch(f){return tdl.error(f),null}return c||(gl.tdl.programs.programDB[d]=e),e},tdl.programs.Program=function(a,b,c){function d(a){function b(a,b){if(1!=a.size)throw"arrays of attribs not handled";return function(a){gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer()),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.numComponents(),a.type(),a.normalize(),a.stride(),a.offset())}}function c(b){var c=gl.getUniformLocation(a,b.name),d=b.type;if(b.size>1&&tdl.string.endsWith(b.name,"[0]")){if(d==gl.FLOAT)return function(a){gl.uniform1fv(c,a)};if(d==gl.FLOAT_VEC2)return function(a){gl.uniform2fv(c,a)};if(d==gl.FLOAT_VEC3)return function(a){gl.uniform3fv(c,a)};if(d==gl.FLOAT_VEC4)return function(a){gl.uniform4fv(c,a)};if(d==gl.INT)return function(a){gl.uniform1iv(c,a)};if(d==gl.INT_VEC2)return function(a){gl.uniform2iv(c,a)};if(d==gl.INT_VEC3)return function(a){gl.uniform3iv(c,a)};if(d==gl.INT_VEC4)return function(a){gl.uniform4iv(c,a)};if(d==gl.BOOL)return function(a){gl.uniform1iv(c,a)};if(d==gl.BOOL_VEC2)return function(a){gl.uniform2iv(c,a)};if(d==gl.BOOL_VEC3)return function(a){gl.uniform3iv(c,a)};if(d==gl.BOOL_VEC4)return function(a){gl.uniform4iv(c,a)};if(d==gl.FLOAT_MAT2)return function(a){gl.uniformMatrix2fv(c,!1,a)};if(d==gl.FLOAT_MAT3)return function(a){gl.uniformMatrix3fv(c,!1,a)};if(d==gl.FLOAT_MAT4)return function(a){gl.uniformMatrix4fv(c,!1,a)};if(d==gl.SAMPLER_2D||d==gl.SAMPLER_CUBE){for(var e=[],f=0;f<b.size;++f)e.push(n++);return function(a){return function(b){gl.uniform1iv(c,a),b.forEach(function(b,c){b.bindToUnit(a[c])})}}(e)}throw"unknown type: 0x"+d.toString(16)}if(d==gl.FLOAT)return function(a){gl.uniform1f(c,a)};if(d==gl.FLOAT_VEC2)return function(a){gl.uniform2fv(c,a)};if(d==gl.FLOAT_VEC3)return function(a){gl.uniform3fv(c,a)};if(d==gl.FLOAT_VEC4)return function(a){gl.uniform4fv(c,a)};if(d==gl.INT)return function(a){gl.uniform1i(c,a)};if(d==gl.INT_VEC2)return function(a){gl.uniform2iv(c,a)};if(d==gl.INT_VEC3)return function(a){gl.uniform3iv(c,a)};if(d==gl.INT_VEC4)return function(a){gl.uniform4iv(c,a)};if(d==gl.BOOL)return function(a){gl.uniform1i(c,a)};if(d==gl.BOOL_VEC2)return function(a){gl.uniform2iv(c,a)};if(d==gl.BOOL_VEC3)return function(a){gl.uniform3iv(c,a)};if(d==gl.BOOL_VEC4)return function(a){gl.uniform4iv(c,a)};if(d==gl.FLOAT_MAT2)return function(a){gl.uniformMatrix2fv(c,!1,a)};if(d==gl.FLOAT_MAT3)return function(a){gl.uniformMatrix3fv(c,!1,a)};if(d==gl.FLOAT_MAT4)return function(a){gl.uniformMatrix4fv(c,!1,a)};if(d==gl.SAMPLER_2D||d==gl.SAMPLER_CUBE)return function(a){return function(b){gl.uniform1i(c,a),b.bindToUnit(a)}}(n++);throw"unknown type: 0x"+d.toString(16)}for(var d={},f={},g=gl.getProgramParameter(a,gl.ACTIVE_ATTRIBUTES),h=0;g>h;++h){var i=gl.getActiveAttrib(a,h);if(!i)break;var j=i.name;tdl.string.endsWith(j,"[0]")&&(j=j.substr(0,j.length-3));var k=gl.getAttribLocation(a,i.name);d[j]=b(i,k),f[j]=k}for(var l=gl.getProgramParameter(a,gl.ACTIVE_UNIFORMS),m={},n=0,o={},h=0;l>h;++h){var i=gl.getActiveUniform(a,h);if(!i)break;j=i.name,tdl.string.endsWith(j,"[0]")&&(j=j.substr(0,j.length-3));var p=c(i);m[j]=p,(i.type==gl.SAMPLER_2D||i.type==gl.SAMPLER_CUBE)&&(o[j]=p)}e.textures=o,e.attrib=d,e.attribLoc=f,e.uniform=m}var e=this;this.programId=tdl.programs.makeProgramId(a,b),this.asyncCallback=c;var f,g,h,i,j=function(a,b,c){f=b+c,tdl.programs.init_();var d=a.tdl.programs.shaderDB[f];if(d)return d;var d=a.createShader(c);return a.shaderSource(d,b),a.compileShader(d),e.asyncCallback||k(d),d},k=function(a){var b=gl.getShaderParameter(a,gl.COMPILE_STATUS);if(!b&&!gl.isContextLost())throw tdl.programs.lastError=gl.getShaderInfoLog(a),gl.deleteShader(a),"*** Error compiling shader :"+tdl.programs.lastError;gl.tdl.programs.shaderDB[f]=a},l=function(a,b,c){var d;try{h=j(a,b,a.VERTEX_SHADER),i=j(a,c,a.FRAGMENT_SHADER),g=a.createProgram(),a.attachShader(g,h),a.attachShader(g,i),n(a,g)}catch(d){m(d)}return g},m=function(a){throw h&&gl.deleteShader(h),i&&gl.deleteShader(i),g&&gl.deleteProgram(g),a},n=function(a,b){a.linkProgram(b),e.asyncCallback||o(b)},o=function(a){var b=gl.getProgramParameter(a,gl.LINK_STATUS);if(!b&&!gl.isContextLost())throw tdl.programs.lastError=gl.getProgramInfoLog(a),"*** Error in program linking:"+tdl.programs.lastError},g=l(gl,a,b);if(!g&&!gl.isContextLost())throw"could not compile program";d(g),this.loadNewShaders=function(a,b){var c=l(gl,a,b);if(!c&&!gl.isContextLost())throw"could not compile program";e.program=c,d()},this.program=g,this.good=this.asyncCallback?!1:!0;var p=function(){var a;try{k(h),k(i),o(g)}catch(a){return void e.asyncCallback(a.toString())}gl.tdl.programs.programDB[e.programId]=this,e.asyncCallback()};this.asyncCallback&&setTimeout(p,1e3)},tdl.programs.handleContextLost_=function(){gl.tdl&&gl.tdl.programs&&gl.tdl.programs.shaderDB&&(delete gl.tdl.programs.shaderDB,delete gl.tdl.programs.programDB)},tdl.programs.init_=function(){gl.tdl.programs||(gl.tdl.programs={},tdl.webgl.registerContextLostHandler(gl.canvas,tdl.programs.handleContextLost_,!0)),gl.tdl.programs.shaderDB||(gl.tdl.programs.shaderDB={},gl.tdl.programs.programDB={})},tdl.programs.Program.prototype.use=function(){gl.useProgram(this.program)},tdl.programs.Program.prototype.setUniform=function(a,b){var c=this.uniform[a];c&&c(b)},tdl.programs.Program.prototype.applyUniforms=function(a){for(var b in a)this.setUniform(b,a[b])},tdl.programs}),define(["./base-rs"],function(){return tdl.provide("tdl.quaternions"),tdl.quaternions=tdl.quaternions||{},tdl.quaternions.mathType=function(a){return"number"==typeof a?"Scalar":"Quaternion"},tdl.quaternions.identity=function(){return[0,0,0,1]},tdl.quaternions.copy=function(a){return a.slice()},tdl.quaternions.negative=function(a){return[-a[0],-a[1],-a[2],-a[3]]},tdl.quaternions.addQuaternionQuaternion=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},tdl.quaternions.addQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]+b)},tdl.quaternions.addScalarQuaternion=function(a,b){return b.slice(0,3).concat(a+b[3])},tdl.quaternions.subQuaternionQuaternion=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},tdl.quaternions.subQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]-b)},tdl.quaternions.subScalarQuaternion=function(a,b){return[-b[0],-b[1],-b[2],a-b[3]]},tdl.quaternions.mulScalarQuaternion=function(a,b){return[a*b[0],a*b[1],a*b[2],a*b[3]]},tdl.quaternions.mulQuaternionScalar=function(a,b){return[b*a[0],b*a[1],b*a[2],b*a[3]]},tdl.quaternions.mulQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];return[f*g+c*j+d*i-e*h,f*h+d*j+e*g-c*i,f*i+e*j+c*h-d*g,f*j-c*g-d*h-e*i]},tdl.quaternions.divQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=1/(j*j+g*g+h*h+i*i);return[(c*j-f*g-d*i+e*h)*k,(c*i-f*h+d*j-e*g)*k,(d*g+e*j-f*i-c*h)*k,(f*j+c*g+d*h+e*i)*k]},tdl.quaternions.divQuaternionScalar=function(a,b){return[a[0]/b,a[1]/b,a[2]/b,a[3]/b]},tdl.quaternions.divScalarQuaternion=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=1/(c*c+d*d+e*e+f*f);return[-a*c*g,-a*d*g,-a*e*g,a*f*g]},tdl.quaternions.inverse=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=1/(b*b+c*c+d*d+e*e);return[-b*f,-c*f,-d*f,e*f]},tdl.quaternions.mul=function(a,b){return tdl.quaternions["mul"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)},tdl.quaternions.div=function(a,b){return tdl.quaternions["div"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)},tdl.quaternions.add=function(a,b){return tdl.quaternions["add"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)},tdl.quaternions.sub=function(a,b){return tdl.quaternions["sub"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)},tdl.quaternions.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},tdl.quaternions.lengthSquared=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},tdl.quaternions.normalize=function(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},tdl.quaternions.conjugate=function(a){return[-a[0],-a[1],-a[2],a[3]]},tdl.quaternions.rotationX=function(a){return[Math.sin(a/2),0,0,Math.cos(a/2)]},tdl.quaternions.rotationY=function(a){return[0,Math.sin(a/2),0,Math.cos(a/2)]},tdl.quaternions.rotationZ=function(a){return[0,0,Math.sin(a/2),Math.cos(a/2)]},tdl.quaternions.axisRotation=function(a,b){var c=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),d=Math.sin(b/2),e=Math.cos(b/2);return[d*a[0]*c,d*a[1]*c,d*a[2]*c,e]},tdl.quaternions.quaternionToRotation=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=e*e,g=e*b,h=e*c,i=e*d,j=b*b,k=b*c,l=b*d,m=c*c,n=c*d,o=d*d,p=f+j+m+o;return[(f+j-m-o)/p,2*(i+k)/p,2*(l-h)/p,0,2*(k-i)/p,(f-j+m-o)/p,2*(g+n)/p,0,2*(h+l)/p,2*(n-g)/p,(f-j-m+o)/p,0,0,0,0,1]},tdl.quaternions.rotationToQuaternion=function(a){var b,c,d;a[0]>a[5]&&a[0]>a[10]?(b=0,c=1,d=2):a[5]>a[0]&&a[5]>a[10]?(b=1,c=2,d=0):(b=2,c=0,d=1);var e=Math.sqrt(1+a[4*b+b]-a[4*c+c]-a[4*d+d]),f=[];return f[b]=.5*e,f[c]=.5*(a[4*c+b]+a[4*b+c])/e,f[d]=.5*(a[4*b+d]+a[4*d+b])/e,f[3]=.5*(a[4*c+d]-a[4*d+c])/e,f},tdl.quaternions}),define(["./base-rs","./io"],function(){return tdl.provide("tdl.screenshot"),tdl.screenshot=tdl.screenshot||{},tdl.screenshot.takeScreenshot=function(a){tdl.io.sendJSON(this.url,{cmd:"screenshot",dataURL:a.toDataURL()},function(){})},tdl.screenshot}),define(["./base-rs"],function(){return tdl.provide("tdl.shader"),tdl.shader=tdl.shader||{},tdl.shader.loadFromScriptNodes=function(a,b,c){var d=document.getElementById(b),e=document.getElementById(c);return d&&e?new tdl.shader.Shader(a,d.text,e.text):null},tdl.shader.glslNameToJs_=function(a){return a.replace(/_(.)/g,function(a,b){return b.toUpperCase()})},tdl.shader.Shader=function(a,b,c){this.program=a.createProgram(),this.gl=a;var d=this.loadShader(this.gl.VERTEX_SHADER,b);d||tdl.log("couldn't load shader"),this.gl.attachShader(this.program,d),this.gl.deleteShader(d);var e=this.loadShader(this.gl.FRAGMENT_SHADER,c);e||tdl.log("couldn't load shader"),this.gl.attachShader(this.program,e),this.gl.deleteShader(e),this.gl.linkProgram(this.program),this.gl.useProgram(this.program);var f=this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS);if(!f&&!this.gl.isContextLost()){var g=this.gl.getProgramInfoLog(this.program);return tdl.error("Error linking program:\n"+g),this.gl.deleteProgram(this.program),void(this.program=null)}for(var h=/(uniform|attribute)\s+\S+\s+(\S+)\s*;/g,i=null;null!=(i=h.exec(b+"\n"+c));){var j=i[2],k=tdl.shader.glslNameToJs_(j),l=-1;"uniform"==i[1]?this[k+"Loc"]=this.getUniform(j):"attribute"==i[1]&&(this[k+"Loc"]=this.getAttribute(j)),l>=0&&(this[k+"Loc"]=l)}},tdl.shader.Shader.prototype.bind=function(){this.gl.useProgram(this.program)},tdl.shader.Shader.prototype.loadShader=function(a,b){var c=this.gl.createShader(a);if(null==c)return null;if(this.gl.shaderSource(c,b),this.gl.compileShader(c),!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){var d=this.gl.getShaderInfoLog(c);return tdl.error("Error compiling shader:\n"+d),this.gl.deleteShader(c),null}return c},tdl.shader.Shader.prototype.getAttribute=function(a){return this.gl.getAttribLocation(this.program,a)},tdl.shader.Shader.prototype.getUniform=function(a){return this.gl.getUniformLocation(this.program,a)},tdl.shader}),define(["./base-rs"],function(){return tdl.provide("tdl.string"),tdl.string=tdl.string||{},tdl.string.endsWith=function(a,b){return a.substr(a.length-b.length)===b},tdl.string.startsWith=function(a,b){return a.substr(0,b.length)===b},tdl.string.argsToString=function(a){for(var b=!1,c=a.length,d=[],e=0;c>e;++e){var f=a[e];
void 0===f?d.push("undefined"):"number"==typeof f?(b&&d.push(", "),d.push(f==Math.floor(f)?f.toFixed(0):f.toFixed(3)),b=!0):window.Float32Array&&f instanceof Float32Array?d.push(tdl.string.argsToString(f)):(d.push(f.toString()),b=!1)}return d.join("")},tdl.string.objToString=function(a){function b(a,d){if(d=d||"","object"==typeof a)if(void 0!==a.length)for(var e=0;e<a.length;++e)b(a[e],d+"["+e+"]");else for(var f in a)b(a[f],d+"."+f);else c.push(tdl.string.argsToString([d,": ",a]))}var c=[];return b(a),c.join("\n")},tdl.string}),define(["./base-rs","./log","./io","./misc"],function(){return tdl.provide("tdl.sync"),tdl.sync=tdl.sync||{},tdl.sync.SyncManager=function(a,b){this.settings=a,this.putCount=0,this.getCount=0,this.callback=b||function(){},tdl.misc.applyUrlSettings(a)},tdl.sync.SyncManager.prototype.init=function(a,b){var c=this;this.sync=!0,this.slave=b,this.socket=new WebSocket(a),this.opened=!1,this.queued=[],this.socket.onopen=function(){tdl.log("SOCKET OPENED!"),c.opened=!0;for(var a=0;a<c.queued.length;++a){var b=c.queued[a];++c.putCount,tdl.log("--PUT:[",c.putCount,"]-------------"),tdl.log(b),c.socket.send(b)}c.queued=[]},this.socket.onerror=function(){tdl.log("SOCKET ERROR!")},this.socket.onclose=function(){tdl.log("SOCKET CLOSED!")},this.socket.onmessage=function(a){++c.getCount,tdl.log("--GET:[",c.getCount,":",a.type,"]-------------");var b=JSON.parse(a.data);tdl.dumpObj(b),tdl.misc.copyProperties(b,c.settings),c.callback(b)}},tdl.sync.SyncManager.prototype.setSettings=function(a){this.sync?this.slave||this.socket&&(this.opened?(++this.putCount,tdl.log("--PUT:[",this.putCount,"]-------------"),tdl.dumpObj(a),this.socket.send(JSON.stringify(a))):this.queued.push(JSON.stringify(a))):(tdl.misc.copyProperties(a,this.settings),this.callback(a))},tdl.sync}),define(["./base-rs","./webgl"],function(){return tdl.provide("tdl.textures"),tdl.textures=tdl.textures||{},tdl.textures.loadTexture=function(a,b,c){var d;if("string"==typeof a)td=a;else if(4==a.length&&"number"==typeof a[0])d=a.toString();else if(1!=a.length&&6!=a.length||"string"!=typeof a[0])if("CANVAS"==a.tagName)d=void 0;else if("IMG"==a.tagName)d=a.src;else{if(!a.width)throw"bad srcs";d=void 0}else d=a.toString();var e;if(tdl.textures.init_(gl),void 0!==d&&(e=gl.tdl.textures.db[d]),e)return e;if("string"==typeof a)e=new tdl.textures.Texture2D(a,b,c);else if(4==a.length&&"number"==typeof a[0])e=new tdl.textures.SolidTexture(a);else if(1!=a.length&&6!=a.length||"string"!=typeof a[0])if("CANVAS"==a.tagName||"IMG"==a.tagName)e=new tdl.textures.Texture2D(a,b);else{if(!a.width)throw"bad srcs";e=new tdl.textures.ColorTexture2D(a)}else e=new tdl.textures.CubeMap(a);return gl.tdl.textures.db[a.toString()]=e,e},tdl.textures.addLoadingImage_=function(a){tdl.textures.init_(gl),gl.tdl.textures.loadingImages.push(a)},tdl.textures.removeLoadingImage_=function(a){gl.tdl.textures.loadingImages.splice(gl.tdl.textures.loadingImages.indexOf(a),1)},tdl.textures.init_=function(a){a.tdl.textures||(a.tdl.textures={},a.tdl.textures.loadingImages=[],tdl.webgl.registerContextLostHandler(a.canvas,tdl.textures.handleContextLost_,!0)),a.tdl.textures.maxTextureSize||(a.tdl.textures.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE),a.tdl.textures.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE)),a.tdl.textures.db||(a.tdl.textures.db={})},tdl.textures.handleContextLost_=function(){if(gl.tdl&&gl.tdl.textures){delete gl.tdl.textures.db;for(var a=gl.tdl.textures.loadingImages,b=0;b<a.length;++b)a[b].onload=void 0;gl.tdl.textures.loadingImages=[]}},tdl.textures.Texture=function(a){this.target=a,this.texture=gl.createTexture(),this.params={}},tdl.textures.Texture.prototype.destroy=function(){gl.deleteTexture(this.texture)},tdl.textures.Texture.prototype.setParameter=function(a,b){this.params[a]=b,gl.bindTexture(this.target,this.texture),gl.texParameteri(this.target,a,b)},tdl.textures.Texture.prototype.setParameterIfNotSet_=function(a,b){this.params[a]||this.setParameter(a,b)},tdl.textures.Texture.prototype.setFilteringBasedOnDimensions=function(a,b){tdl.textures.isPowerOf2(a)&&tdl.textures.isPowerOf2(b)?(this.setParameterIfNotSet_(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(this.target)):(this.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),this.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),this.setParameterIfNotSet_(gl.TEXTURE_MIN_FILTER,gl.LINEAR))},tdl.textures.SolidTexture=function(a){tdl.textures.Texture.call(this,gl.TEXTURE_2D),this.color=a.slice(0,4),this.uploadTexture()},tdl.base.inherit(tdl.textures.SolidTexture,tdl.textures.Texture),tdl.textures.SolidTexture.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture);var a=new Uint8Array(this.color);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,a)},tdl.textures.SolidTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,this.texture)},tdl.textures.DepthTexture=function(a,b){if(!gl.tdl.depthTexture)throw"depth textures not supported";tdl.textures.Texture.call(this,gl.TEXTURE_2D),this.width=a,this.height=b,this.uploadTexture()},tdl.base.inherit(tdl.textures.DepthTexture,tdl.textures.Texture),tdl.textures.DepthTexture.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,this.width,this.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT,null),this.setParameter(gl.TEXTURE_MIN_FILTER,gl.NEAREST),this.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST),this.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),this.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)},tdl.textures.DepthTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,this.texture)},tdl.textures.ColorTexture=function(a,b,c){tdl.textures.Texture.call(this,gl.TEXTURE_2D),this.format=b||gl.RGBA,this.type=c||gl.UNSIGNED_BYTE,a.pixels instanceof Array&&(a.pixels=new Uint8Array(a.pixels)),this.data=a,this.uploadTexture()},tdl.base.inherit(tdl.textures.ColorTexture,tdl.textures.Texture),tdl.textures.ColorTexture.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,this.format,this.data.width,this.data.height,0,this.format,this.type,this.data.pixels),this.setFilteringBasedOnDimensions(this.data.width,this.data.height)},tdl.textures.ColorTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,this.texture)},tdl.textures.Texture2D=function(a,b,c){tdl.textures.Texture.call(this,gl.TEXTURE_2D),this.flipY=b||!1;var d,e=this;"string"!=typeof a?(d=a,this.loaded=!0,c&&c()):(d=document.createElement("img"),tdl.textures.addLoadingImage_(d),d.onload=function(){tdl.textures.removeLoadingImage_(d),e.updateTexture(),c&&c()},d.onerror=function(){tdl.log("could not load image: ",a)}),this.img=d,this.uploadTexture(),this.loaded||(d.src=a)},tdl.base.inherit(tdl.textures.Texture2D,tdl.textures.Texture),tdl.textures.isPowerOf2=function(a){return 0==(a&a-1)},tdl.textures.Texture2D.prototype.uploadTexture=function(){if(gl.bindTexture(gl.TEXTURE_2D,this.texture),this.loaded)gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.setTexture(this.img);else{var a=new Uint8Array([255,255,255,255]);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,a)}},tdl.textures.Texture2D.prototype.setTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a),this.setFilteringBasedOnDimensions(a.width,a.height)},tdl.textures.Texture2D.prototype.updateTexture=function(){this.loaded=!0,this.uploadTexture()},tdl.textures.Texture2D.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,this.texture)},tdl.textures.ExternalTexture=function(a){tdl.textures.Texture.call(this,a),this.type=a},tdl.base.inherit(tdl.textures.ExternalTexture,tdl.textures.Texture),tdl.textures.ExternalTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(this.type,this.texture)},tdl.textures.ExternalTexture2D=function(){tdl.textures.ExternalTexture.call(this,gl.TEXTURE_2D)},tdl.base.inherit(tdl.textures.ExternalTexture2D,tdl.textures.ExternalTexture),tdl.textures.CubeMap=function(a){tdl.textures.init_(gl),tdl.textures.Texture.call(this,gl.TEXTURE_CUBE_MAP),tdl.textures.CubeMap.faceTargets||(tdl.textures.CubeMap.faceTargets=[gl.TEXTURE_CUBE_MAP_POSITIVE_X,gl.TEXTURE_CUBE_MAP_NEGATIVE_X,gl.TEXTURE_CUBE_MAP_POSITIVE_Y,gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,gl.TEXTURE_CUBE_MAP_POSITIVE_Z,gl.TEXTURE_CUBE_MAP_NEGATIVE_Z],tdl.textures.CubeMap.offsets=[[2,1],[0,1],[1,0],[1,2],[1,1],[3,1]]);tdl.textures.CubeMap.faceTargets;if(gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture),this.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),this.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),this.faces=[],a.length){this.numUrls=a.length;for(var b=this,c=0;c<a.length;++c){var d={};this.faces[c]=d;var e=document.createElement("img");tdl.textures.addLoadingImage_(e),d.img=e,e.onload=function(c){return function(){tdl.textures.removeLoadingImage_(e),tdl.log("loaded image: ",a[c]),b.updateTexture(c)}}(c),e.onerror=function(a){return function(){tdl.log("could not load image: ",a)}}(a[c]),e.src=a[c]}}else this.numUrls=0,this.size=a;this.uploadTextures()},tdl.base.inherit(tdl.textures.CubeMap,tdl.textures.Texture),tdl.textures.CubeMap.prototype.loaded=function(){for(var a=0;a<this.faces.length;++a)if(!this.faces[a].loaded)return!1;return!0},tdl.textures.clampToMaxSize=function(a,b){if(a.width<=b&&a.height<=b)return a;var c=Math.max(a.width,a.height),d=Math.floor(a.width*b/c),e=Math.floor(a.height*b/c),f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");return g.drawImage(a,0,0,a.width,a.height,0,0,d,e),f},tdl.textures.CubeMap.prototype.uploadTextures=function(){for(var a=this.loaded(),b=tdl.textures.CubeMap.faceTargets,c=0;6>c;++c){var d=!1,e=b[c];if(this.faces.length){var f=this.faces[Math.min(this.faces.length-1,c)];if(gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture),a){if(gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),6==this.faces.length)gl.texImage2D(e,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tdl.textures.clampToMaxSize(f.img,gl.tdl.textures.maxCubeMapSize));else{var g=document.createElement("canvas"),h=f.img.width/4,i=f.img.height/3;g.width=h,g.height=i;var j=g.getContext("2d"),k=tdl.textures.CubeMap.offsets[c][0]*h,l=tdl.textures.CubeMap.offsets[c][1]*i;j.drawImage(f.img,k,l,h,i,0,0,h,i),gl.texImage2D(e,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tdl.textures.clampToMaxSize(g,gl.tdl.textures.maxCubeMapSize))}d=!0}}if(!d){var m=new Uint8Array([100,100,255,255]);gl.texImage2D(e,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,m)}}var n=!1;if(this.faces.length){var o=this.faces[0].img;n=6==this.faces.length?tdl.textures.isPowerOf2(o.width)&&tdl.textures.isPowerOf2(o.height):tdl.textures.isPowerOf2(o.width/4)&&tdl.textures.isPowerOf2(o.height/3)}n?(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),this.setParameterIfNotSet_(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)):this.setParameterIfNotSet_(gl.TEXTURE_MIN_FILTER,gl.LINEAR)},tdl.textures.CubeMap.prototype.updateTexture=function(a){var b=this.faces[a];b.loaded=!0;var c=this.loaded();c&&this.uploadTextures()},tdl.textures.CubeMap.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture)},tdl.textures}),define(["./base-rs","./log","./misc"],function(){return tdl.provide("tdl.webgl"),tdl.webgl=tdl.webgl||{},gl=null,tdl.webgl.makeCurrent=function(a){gl=a},tdl.webgl.makeFailHTML=function(a){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+a+"</div></div></td></tr></table>"},tdl.webgl.GET_A_WEBGL_BROWSER='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',tdl.webgl.OTHER_PROBLEM='It does not appear your browser or computer supports WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',tdl.webgl.setupWebGL=function(a,b,c){function d(b){var c=a.parentNode;if(c){var d=window.WebGLRenderingContext?tdl.webgl.OTHER_PROBLEM:tdl.webgl.GET_A_WEBGL_BROWSER;b&&(d+="<br/><br/>Status: "+b),c.innerHTML=tdl.webgl.makeFailHTML(d)}}c=c||d,a.addEventListener&&a.addEventListener("webglcontextcreationerror",function(a){c(a.statusMessage)},!1);var e=tdl.webgl.create3DContext(a,b);return e?a.addEventListener&&(a.addEventListener("webglcontextlost",function(b){b.preventDefault(),tdl.webgl.handleContextLost(a)},!1),a.addEventListener("webglcontextrestored",function(){tdl.webgl.handleContextRestored(a)},!1)):c(""),e},tdl.webgl.create3DContext=function(a,b){function c(){return!1}void 0===b&&(b={alpha:!1},tdl.misc.applyUrlSettings(b,"webgl"));for(var d=["webgl","experimental-webgl"],e=null,f=0;f<d.length;++f){try{e=a.getContext(d[f],b)}catch(g){}if(e)break}return e&&(tdl.webgl.glEnums||tdl.webgl.init(e),tdl.webgl.makeCurrent(e),tdl.webgl.setupCanvas_(a),e.tdl={},e.tdl.depthTexture=tdl.webgl.getExtensionWithKnownPrefixes("WEBGL_depth_texture"),a.onselectstart=c,a.onmousedown=c),e},tdl.webgl.setupCanvas_=function(a){a.tdl||(a.tdl={})},tdl.webgl.browserPrefixes_=["","MOZ_","OP_","WEBKIT_"],tdl.webgl.getExtensionWithKnownPrefixes=function(a){for(var b=0;b<tdl.webgl.browserPrefixes_.length;++b){var c=tdl.webgl.browserPrefixes_[b]+a,d=gl.getExtension(c);if(d)return d}},tdl.webgl.runHandlers_=function(a){for(var b=a.slice(),c=0;c<b.length;++c)b[c]()},tdl.webgl.registerContextLostHandler=function(a,b,c){tdl.webgl.setupCanvas_(a),a.tdl.contextLostHandlers||(a.tdl.contextLostHandlers=[[],[]]);var d=a.tdl.contextLostHandlers[c?0:1];d.push(b)},tdl.webgl.registerContextRestoredHandler=function(a,b,c){tdl.webgl.setupCanvas_(a),a.tdl.contextRestoredHandlers||(a.tdl.contextRestoredHandlers=[[],[]]);var d=a.tdl.contextRestoredHandlers[c?0:1];d.push(b)},tdl.webgl.handleContextLost=function(a){a.tdl.contextLostHandlers&&(tdl.webgl.runHandlers_(a.tdl.contextLostHandlers[0]),tdl.webgl.runHandlers_(a.tdl.contextLostHandlers[1]))},tdl.webgl.handleContextRestored=function(a){a.tdl.contextRestoredHandlers&&(tdl.webgl.runHandlers_(a.tdl.contextRestoredHandlers[0]),tdl.webgl.runHandlers_(a.tdl.contextRestoredHandlers[1]))},tdl.webgl.glValidEnumContexts={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},tdl.webgl.glEnums=null,tdl.webgl.init=function(a){if(null==tdl.webgl.glEnums){tdl.webgl.glEnums={};for(var b in a)"number"==typeof a[b]&&(tdl.webgl.glEnums[a[b]]=b)}},tdl.webgl.checkInit=function(){if(null==tdl.webgl.glEnums)throw"tdl.webgl.init(ctx) not called"},tdl.webgl.mightBeEnum=function(a){return tdl.webgl.checkInit(),void 0!==tdl.webgl.glEnums[a]},tdl.webgl.glEnumToString=function(a){if(tdl.webgl.checkInit(),void 0===a)return"undefined";var b=tdl.webgl.glEnums[a];return void 0!==b?b:"*UNKNOWN WebGL ENUM (0x"+a.toString(16)+")"},tdl.webgl.glFunctionArgToString=function(a,b,c){var d=tdl.webgl.glValidEnumContexts[a];return void 0!==d&&d[b]?tdl.webgl.glEnumToString(c):null===c?"null":void 0===c?"undefined":c.toString()},tdl.webgl.glFunctionArgsToString=function(a,b){for(var c="",d=0;d<b.length;++d)c+=(0==d?"":", ")+tdl.webgl.glFunctionArgToString(a,d,b[d]);return c},tdl.webgl.makeDebugContext=function(a,b,c){function d(a,d){return function(){c&&c(d,arguments);try{var e=a[d].apply(a,arguments)}catch(g){throw b(a.NO_ERROR,d,arguments),g}var h=a.getError();return 0!=h&&(f[h]=!0,b(h,d,arguments)),e}}function e(a,b,c){a.__defineGetter__(c,function(){return b[c]}),a.__defineSetter__(c,function(a){b[c]=a})}tdl.webgl.init(a),b=b||function(a,b,c){tdl.error("WebGL error "+tdl.webgl.glEnumToString(a)+" in "+b+"("+tdl.webgl.glFunctionArgsToString(b,c)+")")};var f={},g={};for(var h in a)"function"==typeof a[h]?g[h]=d(a,h):e(g,a,h);return g.getError=function(){for(var b in f)if(f[b])return f[b]=!1,b;return a.NO_ERROR},g},tdl.webgl.requestAnimationFrame=function(a,b){return tdl.webgl.requestAnimationFrameImpl_||(tdl.webgl.requestAnimationFrameImpl_=function(){for(var a=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],b=0;b<a.length;++b){var c=a[b];if(window[c])return function(a){return function(b,c){return window[a].call(window,b,c)}}(c)}return function(a){return window.setTimeout(a,1e3/70)}}()),tdl.webgl.requestAnimationFrameImpl_(a,b)},tdl.webgl.cancelRequestAnimationFrame=function(a){tdl.webgl.cancelRequestAnimationFrameImpl_||(tdl.webgl.cancelRequestAnimationFrameImpl_=function(){for(var a=["cancelRequestAnimationFrame","webkitCancelRequestAnimationFrame","mozCancelRequestAnimationFrame","oCancelRequestAnimationFrame","msCancelRequestAnimationFrame"],b=0;b<a.length;++b){var c=a[b];if(window[c])return function(a){return function(b){window[a].call(window,b)}}(c)}return function(a){window.clearTimeout(a)}}()),tdl.webgl.cancelRequestAnimationFrameImpl_(a)},tdl.webgl});